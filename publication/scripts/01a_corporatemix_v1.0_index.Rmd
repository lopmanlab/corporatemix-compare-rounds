---
title: "Comparison of CorporateMix round 1-4 data"
author: "Moses Kiti"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    # number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, comment = NA)

rm(list=ls())

pacman::p_load("cowplot","dplyr","ggplot2", "ggpubr", "gridExtra", "gtsummary", 
               "Hmisc", "kableExtra", "RColorBrewer", "reshape2",  
                "socialmixr", "table1", "tidyverse")

box_colors <-  c("#08519c","#3182bd","#6baed6","#bdd7e7") # c("#0868ac", "#43a2ca", "7bccc4", "#bae4bc" ) #c("#dfc27d", "#80cdc1", "#a6611a")

source("../../publication/scripts/00_custom_functions.R")

```


```{r load-data, echo=FALSE, include=FALSE, warning=FALSE}

participants <- readRDS("../../publication/data/participants.RDS")
day1_rd1 <- readRDS("../../publication/data/day_rd1.RDS")
contacts <- readRDS("../../publication/data/contacts.RDS")
df_all <- readRDS("../../publication/data/df_all.RDS")
```


### Table 1: Compare characteristics of participants across rounds
Table showing the distribution of participant characteristics by age, sex, education level, family structure, race, Hispanic origins for round 1-4 of the survey.
```{r baseline_participants, echo=FALSE, warnings=FALSE}

label(participants$participant_age) <- "Age"
label(participants$participant_age_2) <- "Age"
label(participants$participant_sex) <- "Sex"
label(participants$education) <- "Education"
label(participants$racehispanic) <- "Race/ Ethnicity"
label(participants$family_structure) <- "Family structure"

t1 <- participants %>%
  select(participant_sex, participant_age_2, education,
         family_structure, racehispanic, round) %>%
  tbl_summary(by=round, 
              percent="column",
              digits = all_categorical() ~ 0,
              missing="no") %>%
  add_overall() %>%
  bold_labels() %>%
  modify_header(label = "") %>%
  modify_spanning_header(c("stat_1", "stat_2", "stat_3") ~ "**Survey round**") %>%
  modify_caption("**Table 1: Baseline characteristics of participants across rounds.**")

t1

# save table
# t1a <- as_tibble(t1)
# write.csv(t1a, "../output/tables/table1.1_participant_characteristics.csv")


```

\
\

### Table 2: Compare characteristics of contacts across rounds
```{r contact_baseline, echo=FALSE, warning=FALSE}

label(df_all$contact_age) <- "Age of contact"
label(df_all$contact_sex) <- "Sex of contact"
label(df_all$contact_type) <- "Type of contact"
label(df_all$contact_location) <- "Location of contact"
label(df_all$contact_duration) <- "Duration of contact"
label(df_all$racehispanic) <- "Hispanic/ Race"


df_all$contact_duration <- factor(df_all$contact_duration,
                                    levels = c("<5 mins", "5-15 mins", "15 mins-1 hr", 
                                             "1-4 hrs", "4+ hrs"))

t2 <- df_all %>%
  select(contact_age, contact_sex, racehispanic, contact_type, contact_location, 
         contact_duration, round) %>%
  tbl_summary(by=round, 
              percent="column",
              digits = all_categorical() ~ 0,
              missing="no") %>%
  add_overall() %>%
  modify_header(label = "") %>%
  modify_spanning_header(c("stat_1", "stat_2", "stat_3") ~ "**Survey round**") %>%
  modify_caption("**Table 2: Characteristics of contacts across rounds.**") %>%
  bold_labels()
t2

# save table
# t2a <- as_tibble(t2)
# write.csv(t2a, "../output/tables/table2_contact_characteristics.csv")
# rm(t2a)

```
\
\

### Table 3: Average contacts by round
```{r table3, include=FALSE}
r1_contacts <- day1_rd1 %>%
  rename(r1_contacts = num_contacts) %>%
  select(participant_id, r1_contacts)

r2_contacts <- df_all %>%
  select("participant_id","round") %>%
  filter(round=="Two") %>%
  dplyr::group_by(participant_id) %>%
  dplyr::summarize(r2_contacts = n(), .groups = "drop")

r3_contacts <- df_all %>%
  select("participant_id","round") %>%
  filter(round=="Three") %>%
  dplyr::group_by(participant_id) %>%
  dplyr::summarize(r3_contacts = n(), .groups = "drop")

r4_contacts <- df_all %>%
  select("participant_id","round") %>%
  filter(round=="Four") %>%
  dplyr::group_by(participant_id) %>%
  dplyr::summarize(r4_contacts = n(), .groups = "drop")

df_allb <- left_join(df_all, r1_contacts, by="participant_id")
df_allb <- left_join(df_allb, r2_contacts, by="participant_id")
df_allb <- left_join(df_allb, r3_contacts, by="participant_id")
df_allb <- left_join(df_allb, r4_contacts, by="participant_id")

df_allb$r1_contacts <- as.numeric(df_allb$r1_contacts)
df_allb$r2_contacts <- as.numeric(df_allb$r2_contacts)
df_allb$r3_contacts <- as.numeric(df_allb$r3_contacts)
df_allb$r4_contacts <- as.numeric(df_allb$r4_contacts)

```


```{r}
list <- list(0)  ## create empty list

## specify participant characteristic stratifications for cross tabs/analysis
variables <- data.frame(var=c("participant_sex","participant_age_2", "family_structure",
                              "contact_location", "racehispanic"),
                        name=c("Sex","Age Group", "Family structure",
                               "Location of contact", "Race/ Ethnicity")) %>% #
  mutate(var = as.character(var),
         name = as.character(name))


for (i in 1:nrow(variables)){
  x <- df_all[,variables$var[[i]]] 
  variables$var[[i]]

# Number and proportion of participants in each strata
  
  t0 <- as.data.frame(cbind(table(x), # Total 
                            round(prop.table(table(x))*100, digits=0))) # Proportion
  
  colnames(t0)[1:2] <- c("Total","Col") 
  Tot <- rep("",5)
  
  # Median contacts for round 1
  t1 <- df_allb %>%
    filter(round =="One") %>%
    distinct(participant_id, .keep_all = TRUE) %>% # since this is total contacts per person, keep only 1 distinct record
    dplyr::group_by(.dots = variables$var[[i]]) %>% 
    do(data.frame(t(quantile(.$r1_contacts, na.rm=TRUE, probs=c(0.25,0.5,0.75))))) # Median and IQR      
  t1$med_contact <- as.character(paste(t1$X50.," (",t1$X25.,"-",t1$X75.,")",sep="")) # Formatting for export
  
  # Median contacts for round 2
  t2 <- df_allb %>%
    filter(round == "Two") %>%
    distinct(participant_id, .keep_all = TRUE) %>% # since this is total contacts per person, keep only 1 distinct record
    dplyr::group_by(.dots = variables$var[[i]]) %>% 
    do(data.frame(t(quantile(.$r2_contacts, na.rm=TRUE, probs=c(0.25,0.5,0.75))))) # Median and IQR      
  t2$med_contact <- as.character(paste(t2$X50.," (",t2$X25.,"-",t2$X75.,")",sep="")) # Formatting for export
  
  # Median contacts for round 3
  t3 <- df_allb %>%
    filter(round == "Three") %>%
    # droplevels(.$race) %>%
    distinct(participant_id, .keep_all = TRUE) %>% # since this is total contacts per person, keep only 1 distinct record
    dplyr::group_by(.dots = variables$var[[i]]) %>% 
    do(data.frame(t(quantile(.$r3_contacts, na.rm=TRUE, probs=c(0.25,0.5,0.75))))) # Median and IQR      
  t3$med_contact <- as.character(paste(t3$X50.," (",t3$X25.,"-",t3$X75.,")",sep="")) # Formatting for export 
  
  # Median contacts for round 4
  t4 <- df_allb %>%
    filter(round == "Four") %>%
    # droplevels(.$race) %>%
    distinct(participant_id, .keep_all = TRUE) %>% # since this is total contacts per person, keep only 1 distinct record
    dplyr::group_by(.dots = variables$var[[i]]) %>% 
    do(data.frame(t(quantile(.$r4_contacts, na.rm=TRUE, probs=c(0.25,0.5,0.75))))) # Median and IQR      
  t4$med_contact <- as.character(paste(t4$X50.," (",t4$X25.,"-",t4$X75.,")",sep="")) # Formatting for export
  #   out <- paste0("This is my output of iteration ", i, ".")  # Some output
  #   print(out)
  # }

  # because R1 has 3 companies compared to 5 in the others, we use qpcR:::cbind.na() to bind the columns regardless of number of rows, else we get an error.
  t0<-qpcR:::cbind.na(t0, t1$med_contact, t2$med_contact, t3$med_contact, t4$med_contact) # Bind columns together

  t0<- t0[,c(1,2,3,4,5,6)]
 
  t0$Total <- paste(t0$Total," (","", t0$Col,")",sep="")
  t0 <- t0[,c(1,3,4,5,6)]
  t0[,2]<-as.character(t0[,2])
  t0[,3]<-as.character(t0[,3])
  t0[,4]<-as.character(t0[,4])
  t0[,5]<-as.character(t0[,5])
  # t0[,6]<-as.character(t0[,6])
 
  t0<-rbind(Tot, t0)
  
  rownames(t0)[1]<-variables$name[[i]]
  list[[i]] <- t0
}

res_restruct<- function(res){
  
  res1 <- lapply(res, as.data.frame)
  res1 <- do.call(rbind, res1)
  return(res1)
}

table_one <- res_restruct(list)
colnames(table_one) <- c("Total (%)", "Round 1", "Round 2", "Round 3", "Round 4")

table_one <- kable(table_one, digits = 0, align = "r") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

table_one
```

\
\

### Graphs of contacts by select covariates
The figure below shows the distribution of contacts by age for rounds 1-4.
```{r graphs1, warning=FALSE, echo=FALSE}

contacts_age <- df_all %>%
  dplyr::group_by(participant_id, participant_age, round) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n(), .groups = "drop")

contacts_sex <- df_all %>%
  dplyr::group_by(participant_id, participant_sex, round) %>%   # group by id and count number of contacts
  filter(participant_sex != "Prefer not to answer") %>% # drop "Prefer not to answer"
  dplyr::summarize(num_contacts = n(), .groups = "drop")

contacts_education <- df_all %>%
  dplyr::group_by(participant_id, education, round) %>%   # group by id and count number of contacts
  drop_na(education) %>%
  dplyr::summarize(num_contacts = n(), .groups = "drop")

contacts_racehispanic <- df_all %>%
  dplyr::group_by(participant_id, racehispanic, round) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n(), .groups = "drop")


box1 <- ggplot(contacts_age, aes(x = participant_age, y = num_contacts, fill=round))
box1 <- box1 +
  geom_boxplot(width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  # theme_cowplot() +
  theme_half_open() +
  scale_fill_manual(values = box_colors, labels = c("1", "2", "3", "4")) +
  scale_y_continuous(limits = c(0, 40)) +
  # xlab("Age group") + 
  # ylab("Number of contacts") + 
  labs(fill="Round",
       x = "Age group",
       y = "Number of contacts" ) +
  theme(legend.title = element_text(size=10),
        legend.text = element_text(size = 8),
        legend.position = c(0.1,0.9)) +
  theme(plot.title = element_text(size = 12), 
        axis.title.x = element_text(size=10, face="bold", angle=0),
        axis.title.y = element_text(size=10, face="bold"),
        axis.text.x = element_text(size = 8), # changed from txt_size (MK)
        axis.text.y = element_text(size= 8))
# box1 

box2 <- ggplot(contacts_sex, aes(x = participant_sex, y = num_contacts, fill=round))
box2 <- box2 +
  geom_boxplot(width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  # theme_cowplot() +
  theme_half_open() +
  scale_fill_manual(values = box_colors) +
  scale_y_continuous(limits = c(0, 40)) +
  xlab("Sex") + 
  ylab("") + 
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 12),
        legend.position = "none") +
  theme(plot.title = element_text(size = 12), 
          axis.title.x = element_text(size=10, face="bold", angle=0),
          axis.title.y = element_text(size=10, face="bold"),
          axis.text.x = element_text(size = 8), # changed from txt_size (MK)
          axis.text.y = element_text(size= 8))


# box3 <- # take out NA as option
box3 <- ggplot(contacts_education, aes(x = education, y = num_contacts, fill=round))
box3 <- box3 +
  geom_boxplot(width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  # theme_cowplot() +
  theme_half_open() +
  scale_fill_manual(values = box_colors) +
  scale_y_continuous(limits = c(0, 40)) +
  xlab("Education") + 
  ylab("Number of contacts") + 
  theme(legend.title= element_blank(),
        legend.text = element_text(size = 12),
        legend.position = "none") +
  theme(plot.title = element_text(size = 12), 
          axis.title.x = element_text(size=10, face="bold", angle=0),
          axis.title.y = element_text(size=10, face="bold"),
          axis.text.x = element_text(size = 8), # changed from txt_size (MK)
          axis.text.y = element_text(size= 8))

box4 <- ggplot(contacts_racehispanic, aes(x = racehispanic, y = num_contacts, fill=round))
box4 <- box4 +
  geom_boxplot(width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  # theme_cowplot() +
  theme_half_open() +
  scale_fill_manual(values = box_colors) +
  scale_y_continuous(limits = c(0, 40)) +
  xlab("Race/ Hispanic") +
  scale_x_discrete(labels = c("Hispanic", "Asian", "Black", "White", "Mixed", "Other")) +
  ylab("") + 
  theme(legend.title= element_blank(),
        legend.text = element_text(size = 12),
        legend.position = c(0.1,0.9)) +
  theme(plot.title = element_text(size = 12), 
          axis.title.x = element_text(size=10, face="bold", angle=0),
          axis.title.y = element_text(size=10, face="bold"),
          axis.text.x = element_text(size = 8), # changed from txt_size (MK)
          axis.text.y = element_text(size= 8))

# legend <- get_legend(box1 + theme(legend.box.margin = margin(0, 0, 0, 12)))

box5 <- plot_grid(box1 + theme(legend.position = "none"), 
                  box2 + theme(legend.position = "none"),
                  box3 + theme(legend.position = "none"),
                  box4 + theme(legend.position = "none"),
                  align = 'vh',
                  labels = c("A","B","C","D"),
                  hjust = -1,
                  label_size = 10, nrow = 2)

# extract the legend from one of the plots
legend <- get_legend(
  box1 +
  theme(legend.position = "right"))

box5 <- plot_grid(box5, legend, rel_widths = c(2,.4))

# tiff("../output/figs/contact_distribution.tiff", units="in", width=8, height=6, res=300)
box5

rm(box1, box2, box3, box4)
```

\
\

```{r graphs2, warning=FALSE, echo=FALSE}

contacts_location_round <- df_all %>%
  dplyr::group_by(participant_id, contact_location, round) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n(), .groups = "drop")

# here, changed to df_allb from contacts_location_round above.
box6 <- df_all %>%
  dplyr::group_by(participant_id, contact_location, round) %>%
  dplyr::summarize(num_contacts = n(), .groups = "drop") %>%
  ggplot(., aes(x = contact_location, y = num_contacts, fill=round))

box6 <- box6 +
  geom_boxplot(width = .50, position = position_dodge(0.6), outlier.size = 0.5, outlier.shape = NA) +
  # theme_cowplot() +
  theme_half_open() +
  scale_fill_manual(labels=c("Apr-Jun '20","Nov'20-Jan'21","Jun-Aug'21","Nov-Dec'21"), 
                    values = box_colors) +
  scale_y_continuous(limits = c(0, 20)) +
  # xlab("Age group") + 
  # ylab("Number of contacts") + 
  labs(fill="Round",
       x = "Setting", #changed from Location to setting
       y = "Number of contacts" ) +
  theme(legend.title = element_text(size=14),
        legend.text = element_text(size = 10),
        legend.position = c(0.1, .95),
        legend.direction="horizontal") +
  theme(plot.title = element_text(size = 12), 
        axis.title.x = element_text(size=20, face="bold", angle=0),
        axis.title.y = element_text(size=20, face="bold"),
        axis.text.x = element_text(size = 16), # changed from txt_size (MK)
        axis.text.y = element_text(size= 16))
box6
# tiff("../output/figs/contact_distribution_location.tiff", units="in", width=8, height=6, res=150)
# dev.off()

median_contacts_rounds <- contacts_location_round %>%
  dplyr::group_by(round, contact_location) %>%
  dplyr::summarize(
    count = n(),
    mean = mean(num_contacts, na.rm = TRUE),
    sd = sd(num_contacts, na.rm = TRUE),
    median = median(num_contacts, na.rm = TRUE),
    # qs = quantile(num_contacts, c(0.25, 0.75)), prob = c(0.25, 0.75))
    q1 = quantile(num_contacts, c(0.25), prob = c(0.25), na.rm = TRUE),
    q3 = quantile(num_contacts, c(0.75), prob = c(0.75), na.rm = TRUE),
    .groups = "drop")

```

```{r, echo=FALSE}

# Define a function to calculate the mean and SD from a bootstrap sample
bootstrap_mean <- function(data, indices) {
  contact_data <- data[indices, ]
  mean_val <- mean(contact_data$num_contacts, na.rm = TRUE)
  sd_val <- sd(contact_data$num_contacts, na.rm = TRUE)
  return(c(mean_val, sd_val))
}

# set seed for reproducibility
set.seed(30322)

# Conduct bootstrapping with 1000 replicates
rd1_mean_bootstrap <- boot(data = day1_rd1, statistic = bootstrap_mean, R = 1000)

rd1_mean <- mean(rd1_mean_bootstrap$t[, 1])
rd1_sd <- sd(rd1_mean_bootstrap$t[, 2])
rd1_ci <- boot.ci(rd1_mean_bootstrap, type = "basic")$basic

# # old code to geberate mean and sd
# meansd_rd1 <- day1_rd1 %>%
#   dplyr::summarize(mean = mean(num_contacts, na.rm = TRUE),
#                    sd = sd(num_contacts, na.rm = TRUE),
#                    .groups = "drop")
  
rd2_mean <- df_all %>%
  filter(round=="Two") %>%
  dplyr::group_by(participant_id) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n(), .groups = "drop")
  # dplyr::summarize(mean = mean(num_contacts, na.rm = TRUE),
  #           sd = sd(num_contacts, na.rm = TRUE), .groups = "drop")

rd2_mean_bootstrap <- boot(data = rd2_mean, statistic = bootstrap_mean, R = 1000)
rd2_mean <- mean(rd2_mean_bootstrap$t[, 1])
rd2_sd <- sd(rd2_mean_bootstrap$t[, 2])
rd2_ci <- boot.ci(rd2_mean_bootstrap, type = "basic")$basic


rd3_mean <- df_all %>%
  filter(round=="Three") %>%
  dplyr::group_by(participant_id) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n(), .groups = "drop")
  # dplyr::summarize(mean = mean(num_contacts, na.rm = TRUE),
  #           sd = sd(num_contacts, na.rm = TRUE), .groups = "drop")
rd3_mean_bootstrap <- boot(data = rd3_mean, statistic = bootstrap_mean, R = 1000)
rd3_mean <- mean(rd3_mean_bootstrap$t[, 1])
rd3_sd <- sd(rd3_mean_bootstrap$t[, 2])
rd3_ci <- boot.ci(rd3_mean_bootstrap, type = "basic")$basic


rd4_mean <- df_all %>%
  filter(round=="Four") %>%
  dplyr::group_by(participant_id) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n(), .groups = "drop")
  # dplyr::summarize(mean = mean(num_contacts, na.rm = TRUE),
  #           sd = sd(num_contacts, na.rm = TRUE), .groups = "drop")
rd4_mean_bootstrap <- boot(data = rd4_mean, statistic = bootstrap_mean, R = 1000)
rd4_mean <- mean(rd4_mean_bootstrap$t[, 1])
rd4_sd <- sd(rd4_mean_bootstrap$t[, 2])
rd4_ci <- boot.ci(rd4_mean_bootstrap, type = "basic")$basic

cat("The mean number of contacts in rd1 is", round(rd1_mean,1), "(95%CI", round(rd1_ci[4],1),"-",round(rd1_ci[5],1),")")
cat("The mean number of contacts in rd2 is", round(rd2_mean,1), "(95%CI", round(rd2_ci[4],1),"-",round(rd2_ci[5],1),")")
cat("The mean number of contacts in rd3 is", round(rd3_mean,1), "(95%CI", round(rd3_ci[4],1),"-",round(rd3_ci[5],1),")")
cat("The mean number of contacts in rd4 is", round(rd4_mean,1), "(95%CI", round(rd4_ci[4],1),"-",round(rd4_ci[5],1),")")

```

\
\

# Median contacts at work, home and community by round
```{r}
median_contacts_rounds
```

\
\

### Comparison of median (IQR) contacts by round.
```{r stat_tests, warning=FALSE, echo=FALSE, include=FALSE, comment = NA}
# Here, I compute the number of contacts as a line list count of each person with whom the participant had a contact. This is done same way as for temp 2.  
# temp2 <- df_all %>%
#   filter(round=="Two") %>% # keep round 1 contacts only
#   dplyr::group_by(participant_id, participant_age) %>%   # group by id and count number of contacts
#   dplyr::summarize(num_contacts = n()) %>%
#   mutate(round="Two")

# However, doing it the way above (temp2) produces summary results that are different from what we reported in the manuscript we published. Hence, I use the variable day1_rd1$social_cont file to compute the summary statistics.

temp1 <- day1_rd1 %>%
  # rename(num_contacts = social_cont) %>%
  .[!duplicated(.$participant_id),] %>%
  select(participant_id, num_contacts) %>%
  mutate(round="One")

temp2 <- df_all %>%
  filter(round=="Two") %>% # keep round 2 contacts only
  dplyr::group_by(participant_id, participant_age) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n(), .groups = "drop") %>%
  select(participant_id, num_contacts) %>%
  mutate(round="Two")

temp3 <- df_all %>%
  filter(round=="Three") %>% # keep round 3 contacts only
  dplyr::group_by(participant_id, participant_age) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n(), .groups = "drop") %>%
  select(participant_id, num_contacts) %>%
  mutate(round="Three")

temp4 <- df_all %>%
  filter(round=="Four") %>% # keep round 4 contacts only
  dplyr::group_by(participant_id, participant_age) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n(), .groups = "drop") %>%
  select(participant_id, num_contacts) %>%
  mutate(round="Four")


df_contacts_round <- rbind(temp1, temp2, temp3, temp4)
rm(temp1, temp2, temp3, temp4)

# 1. here, for each of the rounds, we calculate the mean (sd) and median (IQR) values. Due to the non-normal distribution of the data, we conduct a Kruskal-Wallis rank-sum test of significance.
summary_rounds <- dplyr::group_by(df_contacts_round, round) %>%
  dplyr::summarize(
    count = n(),
    mean = mean(num_contacts, na.rm = TRUE),
    sd = sd(num_contacts, na.rm = TRUE),
    median = median(num_contacts, na.rm = TRUE),
    # qs = quantile(num_contacts, c(0.25, 0.75)), prob = c(0.25, 0.75))
    q1 = quantile(num_contacts, c(0.25), prob = c(0.25), na.rm = TRUE),
    q3 = quantile(num_contacts, c(0.75), prob = c(0.75), na.rm = TRUE),
    .groups = "drop")
# summary_rounds

# 2. Kruskall Wallis test of change.
test_rounds_12 <- df_contacts_round %>%
  filter(round=="One" | round=="Two")
test_rounds_12 <- kruskal.test(num_contacts ~ round, 
                            data = test_rounds_12)

test_rounds_23 <- df_contacts_round %>%
  filter(round=="Two" | round=="Three")
test_rounds_23 <- kruskal.test(num_contacts ~ round, 
                            data = test_rounds_23)

test_rounds_34 <- df_contacts_round %>%
  filter(round=="Three" | round=="Four")
test_rounds_34 <- kruskal.test(num_contacts ~ round, 
                            data = test_rounds_34)
# test_rounds

# # Visualization
# library("ggpubr")
# 
# p1 <- ggplot(df_contacts_round, aes(x = round, y = num_contacts, fill = round)) +
#   geom_bar(stat = "identity", position = position_dodge(0.1)) +
#   stat_summary(fun = "median", geom = "text", 
#                aes(label = round(..y.., digits = 2), group = round),
#                position = position_dodge(0.1), vjust = -0.5, color = "black", size = 3) +
#   labs(x = "Round", y = "Number of contacts") +
#   scale_fill_manual(values = box_colors) +
#   theme_minimal() +
#   theme(legend.position = "none")# +
#   geom_text(aes(y = after_stat(y - 0.2)), vjust = 0, size = 3)  # Adjust text position
# 
# 
# p1 <- ggbarplot(df_contacts_round, x = "round", y = "num_contacts",
#        add = c("median_q1q3"),
#        order = c("One", "Two", "Three", "Four"),
#        color = c("black"),
#        fill = box_colors,
#        ylab = "Number of contacts", xlab = "Round",
#        label=TRUE,
#        lab.vjust = -1.0, lab.hjust = -1.0,
#        position = position_dodge(0.1))
# # tiff("../output/figs/fig2_median_all_rounds.tiff", units="in", width=6, height=6, res=300)
# p1
# # dev.off()
# There is a significant difference in the mean contact values between round 1 and round 2 (Kruskal-Wallis rank sum test, p=`r test_rounds_12$p.value`) and round 2 and 3 (Kruskal-Wallis rank sum test, p=`r test_rounds_23$p.value`).

```
\
\
```{r}
# p1
```
The median (IQR) contact rates for round 1, 2,  3 and 4 were 
`r summary_rounds$median[2]` (`r summary_rounds$q1[2]`, `r summary_rounds$q3[2]`),  
`r summary_rounds$median[4]` (`r summary_rounds$q1[4]`, `r summary_rounds$q3[4]`), 
`r summary_rounds$median[3]` (`r summary_rounds$q1[3]`, `r summary_rounds$q3[3]`), and
`r summary_rounds$median[1]` (`r summary_rounds$q1[1]`, `r summary_rounds$q3[1]`), 
respectively.

\
\


```{r}
make_matrix_rd2 <- function(df1, title, txt_size = 12, mid = 2.5, max = 5.0, legendpos = "top", n_bootstrap = 1000, alpha = 0.05) {
  df1 %>%
    group_by(participant_age, contact_age) %>%
    dplyr::summarize(tot_contacts = n()) %>%
    full_join(standard_str, by = c("participant_age", "contact_age"), keep = FALSE) %>%
    replace(is.na(.), 0) %>%
    left_join(num_participants_rd2, by = "participant_age") %>%
    mutate(avg_cont = (tot_contacts / n),
           avg_cont = replace_na(avg_cont, 0),
           avg_cont = na_if(avg_cont, 0)) %>%
    na.omit() %>%
    group_by(participant_age) %>%
    # print() %>%
    boot::boot(data = ., statistic = function(data, indices) {
      sample_data <- data[indices, ]
      mean_avg_cont <- mean(sample_data$avg_cont)
      return(mean_avg_cont)
    }, R = n_bootstrap) %>%
    boot::boot.ci(type = "bca", conf = 1 - alpha)  %>%
    print(.$bca)
}
    # as.data.frame() %>%
    # pivot_wider(names_from = Statistic, values_from = c("2.5 %", "97.5 %")) %>%
    mutate(avg_cont = round(Statistic.Mean, 2),
           lower_ci = round(`2.5 %`, 2),
           upper_ci = round(`97.5 %`, 2)) %>%
    select(participant_age, avg_cont, lower_ci, upper_ci) %>%
    contactmatrix_viz(title = title, txt_size = txt_size, mid = mid, max = max, legendpos = legendpos)
}

# Usage example:
result <- make_matrix_rd2(df_rd2_temp, title = "Matrix Title")
print(result)
```

### Matrices by study round
```{r graphs3, warning=FALSE, echo=FALSE, comment = NA, fig.width = 18, fig.height = 14}

# Data by rounds
rd1 <- df_all %>%
  filter(round == "One") %>%
  mutate(participant_age = as.character(participant_age),
         contact_age = as.character(contact_age))
rd2 <- df_all %>%
  filter(round == "Two") %>%
  mutate(participant_age = as.character(participant_age),
         contact_age = as.character(contact_age))
rd3 <- df_all %>%
  filter(round == "Three") %>%
  mutate(participant_age = as.character(participant_age),
         contact_age = as.character(contact_age))
rd4 <- df_all %>%
  filter(round == "Four") %>%
  mutate(participant_age = as.character(participant_age),
         contact_age = as.character(contact_age))

# participants$participant_age <- as.character(participants$participant_age)
# contacts$contact_age <- as.character(contacts$contact_age)


## Create dummy data frame of standard structure for contact matrix
standard_str <- data.frame(participant_age = rep(c("0-9","10-19","20-29","30-39","40-59","60+"),6),
                            contact_age = rep(unique(contacts$contact_age),each = 6))
standard_str$contact_age <- as.character(standard_str$contact_age)


## Number participants by age group
num_participants_rd1 <- participants %>%
  filter(round == "One") %>%
  dplyr::group_by(participant_age) %>%
  dplyr::summarize(n=n(), .groups = "drop")
num_participants_rd1$participant_age <- as.character(num_participants_rd1$participant_age) 

## Contact matrices

## Round 1
m1_rd1 <- make_matrix_rd1(rd1,
                          title = "A. Apr-Jun 2020 (N=304)",
                          legendpos ="none") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), 
            color = "black", size = 8) +
  theme(axis.title.x = element_blank())


## Round 2 matrix
df_rd2_temp <- rd2 %>%
  select(participant_id, participant_age, contact_age) 
df_rd2_temp$participant_age <- as.character(df_rd2_temp$participant_age)
df_rd2_temp$contact_age <- as.character(df_rd2_temp$contact_age)

## Number participants by age group
num_participants_rd2 <- participants %>%
  filter(round == "Two") %>%
  dplyr::group_by(participant_age) %>%
  dplyr::summarize(n=n(), .groups = "drop")

m1_rd2 <- make_matrix_rd2(
  df_rd2_temp %>%
    filter(!is.na(contact_age)), # Remove those without contact age
  replace(is.na(.), 0),
  title = "B. Nov 2020-Jan 2021 (N=343)",
  legendpos ="none") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), 
            color = "black", size = 8) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())
  


## Round 3 matrix
df_rd3_temp <- rd3 %>%
  select(participant_id, participant_age, contact_age)
df_rd3_temp$participant_age <- as.character(df_rd3_temp$participant_age)
df_rd3_temp$contact_age <- as.character(df_rd3_temp$contact_age)

## Number participants by age group
num_participants_rd3 <- participants %>%
  filter(round == "Three") %>%
  dplyr::group_by(participant_age) %>%
  dplyr::summarize(n=n(), .groups = "drop")

m1_rd3 <- make_matrix_rd3(
  df_rd3_temp %>%
    filter(!is.na(contact_age)), # Remove those without contact age
  replace(is.na(.), 0),
  title = "C. Jun-Aug 2021 (N=376)",
  legendpos ="none") +   
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), 
            color = "black", size = 8)



## Round 4 matrix
df_rd4_temp <- rd4 %>%
  select(participant_id, participant_age, contact_age)
df_rd4_temp$participant_age <- as.character(df_rd4_temp$participant_age)
df_rd4_temp$contact_age <- as.character(df_rd4_temp$contact_age)

## Number participants by age group
num_participants_rd4 <- participants %>%
  filter(round == "Four") %>%
  dplyr::group_by(participant_age) %>%
  dplyr::summarize(n=n(), .groups = "drop")

m1_rd4 <- make_matrix_rd4(
  df_rd4_temp %>%
    filter(!is.na(contact_age)), # Remove those without contact age
  replace(is.na(.), 0),
  title = "D. Nov-Dec 2021 (N=433)",
  legendpos ="none") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), 
            color = "black", size = 8) +
  theme(axis.title.y = element_blank())


# get legend
legend_m1 <- get_legend(m1_rd4 +
                          guides(color = guide_legend(nrow = 1)) +
                          theme(legend.position = "right",
                                legend.justification = "left"))

m_all <- plot_grid(m1_rd1, m1_rd2, legend_m1,
                   m1_rd3, m1_rd4,
          # labels = c("A","B","","C","D"),
          # label_size = 22,
          ncol=3, nrow=2, rel_widths=c(1.2,1.15,.2),
          scale=0.95, align="hv")

m_all
```

\
\

### Matrices by location of contact
```{r location_matrices, warning=FALSE, echo=FALSE, comment = NA, fig.width = 24, fig.height = 18}

age_labels <- c("0-9"="0-", "10-19"="10-", "20-29"="20-",
"30-39"="30-", "40-59"="40-", "60+"="60+")

# Work
## Round 1
m1_rd1_work <- make_matrix_rd1(
  rd1 %>%
    filter(contact_location=="Work"),
  title = "",
  legendpos ="") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), 
            color = "black", size = 5) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 20),
        axis.title.y = element_text(size = 25)) +
   theme(panel.background = element_rect(fill='transparent'),
         plot.background = element_rect(fill='transparent', color=NA)) +
  labs(title="Round 1") 
# m1_rd1_work

## Round 2
m1_rd2_work <- make_matrix_rd2(
  rd2 %>%
    filter(contact_location=="Work"),
  title = "", 
  legendpos ="") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank()) +
     theme(panel.background = element_rect(fill='transparent'),
           plot.background = element_rect(fill='transparent', color=NA)) +
  labs(title="Round 2")
# m1_rd2_work

## Round 3
m1_rd3_work <- make_matrix_rd3(
  rd3 %>%
    filter(contact_location=="Work"),
  title = "", 
  legendpos ="") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank()) +
     theme(panel.background = element_rect(fill='transparent'),
           plot.background = element_rect(fill='transparent', color=NA)) +
  labs(title="Round 3")
# m1_rd3_work

# Round 4
m1_rd4_work <- make_matrix_rd4(
  rd3 %>%
    filter(contact_location=="Work"),
  title = "", 
  legendpos ="") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank()) +
     theme(panel.background = element_rect(fill='transparent'),
           plot.background = element_rect(fill='transparent', color=NA)) +
  labs(title="Round 4")
# m1_rd4_work


# Home
m1_rd1_home <- make_matrix_rd1(
  rd1 %>%
    filter(contact_location=="Home"),
  title = "",
  legendpos ="") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 20),
        axis.title.y = element_text(size = 25)) +
   theme(panel.background = element_rect(fill='transparent'),
         plot.background = element_rect(fill='transparent', color=NA))
# m1_rd1_home

## Round 2
m1_rd2_home <- make_matrix_rd2(
  rd2 %>%
    filter(contact_location=="Home"),
  title = "", 
  legendpos ="") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  theme(panel.background = element_rect(fill='transparent'),
        plot.background = element_rect(fill='transparent', color=NA)) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank())
# m1_rd2_home

## Round 3
m1_rd3_home <- make_matrix_rd3(
  rd3 %>%
    filter(contact_location=="Home"),
  title = "", 
  legendpos ="")  +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  theme(panel.background = element_rect(fill='transparent'),
        plot.background = element_rect(fill='transparent', color=NA)) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank())
# m1_rd3_home

# Round 4
m1_rd4_home <- make_matrix_rd4(
  rd4 %>%
    filter(contact_location=="Home"),
  title = "", 
  legendpos ="") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +    
  theme(panel.background = element_rect(fill='transparent'),
        plot.background = element_rect(fill='transparent', color=NA)) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank())
# m1_rd4_home


# Community
m1_rd1_comm <- make_matrix_rd1(
  rd1 %>%
    filter(contact_location=="Community"),
  title = "",
  legendpos ="")  +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  scale_x_discrete(labels=age_labels) +
  theme(axis.title.x = element_text(size = 25),
        axis.text.x = element_text(size = 20),
        axis.title.y = element_text(size = 25),
        axis.text.y = element_text(size = 20)) +
   theme(panel.background = element_rect(fill='transparent'),
         plot.background = element_rect(fill='transparent', color=NA))
# m1_rd1_comm

## Round 2
m1_rd2_comm <- make_matrix_rd2(
  rd2 %>%
    filter(contact_location=="Community"),
  title = "", 
  legendpos ="") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  theme(panel.background = element_rect(fill='transparent'),
        plot.background = element_rect(fill='transparent', color=NA)) +
  scale_x_discrete(labels=age_labels) +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 25),
        axis.text.x = element_text(size = 20))
# m1_rd2_comm

## Round 3
m1_rd3_comm <- make_matrix_rd3(
  rd3 %>%
    filter(contact_location=="Community"),
  title = "", 
  legendpos ="")  +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  scale_x_discrete(labels=age_labels) +
  theme(axis.title.x = element_text(size = 25),
        axis.text.x = element_text(size = 20),
        axis.title.y = element_blank(),
        axis.text.y = element_blank()) +
  theme(panel.background = element_rect(fill='transparent'),
        plot.background = element_rect(fill='transparent', color=NA))
  
# m1_rd3_comm

# Round 4
m1_rd4_comm <- make_matrix_rd4(
  rd4 %>%
    filter(contact_location=="Community"),
  title = "", 
  legendpos ="") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), 
            color = "black", size = 5) +
  scale_x_discrete(labels=age_labels) +
  theme(axis.title.x = element_text(size = 25),
        axis.text.x = element_text(size = 20),
        axis.title.y = element_blank(),
        axis.text.y = element_blank()) +
  theme(panel.background = element_rect(fill='transparent'),
        plot.background = element_rect(fill='transparent', color=NA))

# m1_rd4_comm
legend_b <- get_legend(m1_rd4_comm +
                          guides(color = guide_legend(nrow = 1)) +
                          theme(legend.position = "bottom",
                                legend.justification = "right"))

m_location <- plot_grid(NULL, m1_rd1_work, m1_rd2_work, m1_rd3_work, m1_rd4_work,
                        NULL, m1_rd1_home, m1_rd2_home, m1_rd3_home, m1_rd4_home, 
                        NULL, m1_rd1_comm, m1_rd2_comm, m1_rd3_comm, m1_rd4_comm,
                        NULL, NULL, legend_b, NULL,
                        nrow=4, ncol=5, align="hv",
                        rel_widths=c(.2, 1.1, 0.85, 0.85, 0.85), rel_heights=c(1,1,1.1,0.2), scale=0.9,
                        labels = c('Work','','','', '',
                                   'Home', '', '', '', '',
                                   'Community', '', '', '', '',
                                   '', '', '', '',''),
                        label_size=30, bg='transparent')


print(m_location)

```

```{r, include=FALSE}
# pdf("../output/figs/matrix_location_all.pdf", width=24, height=18)
# m_location
# dev.off()
```

```{r matrix_dfs, warning=FALSE, echo=FALSE, include=FALSE}

# matrix dataframes
## Round 1
df_m1_rd1 <- rd1 %>%
  dplyr::group_by(participant_age, contact_age) %>%
  dplyr::summarize(tot_contacts = n(), .groups = "drop") %>%
  full_join(standard_str, by = c("participant_age","contact_age"), keep=F) %>%
  left_join(num_participants_rd1, by="participant_age") %>%
  mutate(avg_cont = (tot_contacts/n)) %>%
  replace(is.na(.), 0)

## Round 2
df_m1_rd2 <- rd2 %>%
  dplyr::group_by(participant_age, contact_age) %>%
  dplyr::summarize(tot_contacts = n(), .groups = "drop") %>%
  full_join(standard_str, by = c("participant_age","contact_age"), keep=F) %>%
  left_join(num_participants_rd1, by="participant_age") %>%
  mutate(avg_cont = (tot_contacts/n)) %>%
  replace(is.na(.), 0)

## Round 3
df_m1_rd3 <- rd3 %>%
  dplyr::group_by(participant_age, contact_age) %>%
  dplyr::summarize(tot_contacts = n(), .groups = "drop") %>%
  full_join(standard_str, by = c("participant_age","contact_age"), keep=F) %>%
  left_join(num_participants_rd1, by="participant_age") %>%
  mutate(avg_cont = (tot_contacts/n)) %>%
  replace(is.na(.), 0)

## Round 4
df_m1_rd4 <- rd4 %>%
  dplyr::group_by(participant_age, contact_age) %>%
  dplyr::summarize(tot_contacts = n(), .groups = "drop") %>%
  full_join(standard_str, by = c("participant_age","contact_age"), keep=F) %>%
  left_join(num_participants_rd1, by="participant_age") %>%
  mutate(avg_cont = (tot_contacts/n)) %>%
  replace(is.na(.), 0)

```


### Difference matrices among employees only
```{r weighted_matrix_dfs, warning=FALSE, echo=FALSE, comment = NA, fig.width = 18, fig.height = 14}

# employee weighted population data
employee_pop <- read_csv("../../publication/data/us_company_weights_052021.csv",
                            col_types = cols())
# select(age_cat, p_age, age_weight) %>%
employee_pop <-  as.numeric(employee_pop$n_employees)

col_names <- c("60+","40-59","30-39","20-29","10-19","0-9")
row_names <- c("60+","40-59","30-39","20-29","10-19","0-9")

# round 1 weighted matrix
# number of participants per age group, from part_age1
n_rd1 <- as.numeric(num_participants_rd1$n)

# unweighted matrix
m_rd1 <- matrix(df_m1_rd1$avg_cont,6,6,byrow=F)
m_rd1[is.na(m_rd1)] = 0

# this generates a square weighted reciprocal matrix for ages >20 years.
k <- 6
m_rd1_w <- matrix(0,k,k) 

for(i in 1:k){
  for(j in 1:k){
    m_rd1_w[i,j] <- (m_rd1[i,j]*employee_pop[i] + m_rd1_w[j,i]*employee_pop[j]) / 
      (employee_pop[i] + employee_pop[j])
    if(is.na(m_rd1_w[i,j]) | is.infinite(m_rd1_w[i,j])) m_rd1_w[i,j] <- 0
  }
}
m_rd1_w <- as.data.frame(m_rd1_w)
rownames(m_rd1_w) <- row_names
colnames(m_rd1_w) <- col_names

# round 2 weighted matrix
# number of participants per age group, from part_age1
n_rd2 <- as.numeric(num_participants_rd2$n)

# unweighted matrix
m_rd2 <- matrix(df_m1_rd2$avg_cont,6,6,byrow=F)
m_rd2[is.na(m_rd2)] = 0

# this generates a square weighted reciprocal matrix for ages >20 years.
# k <- 6
m_rd2_w <- matrix(0,k,k) 

for(i in 1:k){
  for(j in 1:k){
    m_rd2_w[i,j] <- (m_rd2[i,j]*employee_pop[i] + m_rd2_w[j,i]*employee_pop[j]) / 
      (employee_pop[i] + employee_pop[j])
    if(is.na(m_rd2_w[i,j]) | is.infinite(m_rd2_w[i,j])) m_rd2_w[i,j] <- 0
  }
}
m_rd2_w <- as.data.frame(m_rd2_w)
rownames(m_rd2_w) <- row_names
colnames(m_rd2_w) <- col_names


# round 3 weighted matrix
# number of participants per age group, from part_age1
n_rd3 <- as.numeric(num_participants_rd3$n)

# unweighted matrix
m_rd3 <- matrix(df_m1_rd3$avg_cont,6,6,byrow=F)
m_rd3[is.na(m_rd3)] = 0

# this generates a square weighted reciprocal matrix for ages >20 years.
# k <- 6
m_rd3_w <- matrix(0,k,k) 

for(i in 1:k){
  for(j in 1:k){
    m_rd3_w[i,j] <- (m_rd3[i,j]*employee_pop[i] + m_rd3_w[j,i]*employee_pop[j]) / 
      (employee_pop[i] + employee_pop[j])
    if(is.na(m_rd3_w[i,j]) | is.infinite(m_rd3_w[i,j])) m_rd3_w[i,j] <- 0
  }
}
m_rd3_w <- as.data.frame(m_rd3_w)
rownames(m_rd3_w) <- row_names
colnames(m_rd3_w) <- col_names


# round 4 weighted matrix
# number of participants per age group, from part_age1
n_rd4 <- as.numeric(num_participants_rd4$n)

# unweighted matrix
m_rd4 <- matrix(df_m1_rd4$avg_cont,6,6,byrow=F)
m_rd4[is.na(m_rd4)] = 0

# this generates a square weighted reciprocal matrix for ages >20 years.
# k <- 6
m_rd4_w <- matrix(0,k,k) 

for(i in 1:k){
  for(j in 1:k){
    m_rd4_w[i,j] <- (m_rd4[i,j]*employee_pop[i] + m_rd4_w[j,i]*employee_pop[j]) / 
      (employee_pop[i] + employee_pop[j])
    if(is.na(m_rd4_w[i,j]) | is.infinite(m_rd4_w[i,j])) m_rd4_w[i,j] <- 0
  }
}
m_rd4_w <- as.data.frame(m_rd4_w)
rownames(m_rd4_w) <- row_names
colnames(m_rd4_w) <- col_names

```
\
\

### Difference matrices among employees only
```{r difference_matrix, warning=FALSE, echo=FALSE, comment = NA, fig.width = 18, fig.height = 14}
# round 1-2
diff1 <- m_rd2 - m_rd1
colnames(diff1) <- col_names
rownames(diff1) <- row_names

diff1 <- diff1 %>%
  as.data.frame() %>%
  rownames_to_column("participant_age") %>%
  pivot_longer(-c(participant_age), names_to = "contact_age", values_to = "avg_cont") 

diff_matr1 <- diff1 %>%
  filter(contact_age!="0-9") %>% filter(participant_age!="0-9") %>%
  filter(contact_age!="10-19") %>%  filter(participant_age!="10-19") %>%
  ggplot(aes(x=participant_age, y=contact_age, fill=avg_cont)) +
  geom_raster() +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), 
            color = "black", size = 8) +
  theme_classic() +
  scale_fill_gradient2(low="blue", mid="white", high="purple", 
                       limits=c(-4, 4), breaks=(c(-4,-2,0,2,4))) +
  labs(fill = "Average \ncontact") +
  xlab("") + 
  ylab("Contact age") +
  ggtitle("A. Round 1 - 2") +
  theme(legend.title = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.justification = "right",
        legend.position = "") +
  theme(plot.title = element_text(size = 28), 
        axis.title.x = element_text(size=26, face="bold", angle=0),
        axis.title.y = element_text(size=26, face="bold"),
        axis.text.x = element_text(size = 24),
        axis.text.y = element_text(size= 24))
# diff_matr1

# round 2-3
diff2 <- m_rd3_w - m_rd2_w
colnames(diff2) <- col_names
rownames(diff2) <- row_names

diff2 <- diff2 %>%
  as.data.frame() %>%
  rownames_to_column("participant_age") %>%
  pivot_longer(-c(participant_age), names_to = "contact_age", values_to = "avg_cont") 

diff_matr2 <- diff2 %>%
  filter(contact_age!="0-9") %>% filter(participant_age!="0-9") %>%
  filter(contact_age!="10-19") %>%  filter(participant_age!="10-19") %>%
  ggplot(aes(x=participant_age, y=contact_age, fill=avg_cont)) +
  geom_raster() +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), 
            color = "black", size = 8) +
  theme_classic() +
  scale_fill_gradient2(low="blue", mid="white", high="purple", 
                       limits=c(-4, 4), breaks=(c(-4,-2,0,2,4))) +
  xlab("") + 
  ylab("") +
  ggtitle("B. Round 2 - 3") +
  theme(legend.title = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.justification = "right",
        legend.position = "") +
  theme(plot.title = element_text(size = 28), 
        axis.title.x = element_text(size=26, face="bold", angle=0),
        axis.title.y = element_text(size=26, face="bold"),
        axis.text.x = element_text(size = 24),
        axis.text.y = element_text(size= 24))
# diff_matr2

# round 4-3
diff3 <- m_rd4_w - m_rd3_w
colnames(diff3) <- col_names
rownames(diff3) <- row_names

diff3 <- diff3 %>%
  as.data.frame() %>%
  rownames_to_column("participant_age") %>%
  pivot_longer(-c(participant_age), names_to = "contact_age", values_to = "avg_cont")

diff_matr3 <- diff3 %>%
  filter(contact_age!="0-9") %>% filter(participant_age!="0-9") %>%
  filter(contact_age!="10-19") %>%  filter(participant_age!="10-19") %>%
  ggplot(aes(x=participant_age, y=contact_age, fill=avg_cont)) +
  geom_raster() +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), 
            color = "black", size = 8) +
  theme_classic() +
  scale_fill_gradient2(low="blue", mid="white", high="purple", 
                       limits=c(-4, 4), breaks=(c(-4,-2,0,2,4))) +
  xlab("Participant age") + 
  ylab("Contact age") +
  ggtitle("C. Round 3 - 4") +
  theme(legend.title = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.justification = "right",
        legend.position = "") +
  theme(plot.title = element_text(size = 28), 
        axis.title.x = element_text(size=26, face="bold", angle=0),
        axis.title.y = element_text(size=26, face="bold"),
        axis.text.x = element_text(size = 24),
        axis.text.y = element_text(size= 24))
# diff_matr3

# round 1-4
diff4 <- m_rd4_w - m_rd1_w
colnames(diff4) <- col_names
rownames(diff4) <- row_names

diff4 <- diff4 %>%
  as.data.frame() %>%
  rownames_to_column("participant_age") %>%
  pivot_longer(-c(participant_age), names_to = "contact_age", values_to = "avg_cont") 

diff_matr4 <- diff4 %>%
  filter(contact_age!="0-9") %>% filter(participant_age!="0-9") %>%
  filter(contact_age!="10-19") %>%  filter(participant_age!="10-19") %>%
  ggplot(aes(x=participant_age, y=contact_age, fill=avg_cont)) +
  geom_raster() +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), 
            color = "black", size = 8) +
  theme_classic() +
  scale_fill_gradient2(low="blue", mid="white", high="purple", 
                       limits=c(-4, 4), breaks=(c(-4,-2,0,2,4))) +
  xlab("Participant age") + 
  ylab("") +
  ggtitle("D. Round 1 - 4 (Overall)") +
  theme(legend.title = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.justification = "right",
        legend.position = "") +
  theme(plot.title = element_text(size = 28), 
        axis.title.x = element_text(size=26, face="bold", angle=0),
        axis.title.y = element_text(size=26, face="bold"),
        axis.text.x = element_text(size = 24),
        axis.text.y = element_text(size= 24))
# diff_matr4


# get legend
legend_mdiff <- get_legend(
  diff_matr1 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "right",
          legend.justification = "left"))

diff_matrix <- plot_grid(diff_matr1, diff_matr2, legend_mdiff,
                         diff_matr3, diff_matr4,
                         # labels = c("A","B","",
                                    # "C","D"),
                         # label_size = 18, 
                         ncol=3, nrow=2, rel_widths = c(1,1,.2),
                         scale=0.95, align="hv")


print(diff_matrix)
```


```{r, save-figs,include=FALSE}

# pdf("../output/figs/contact_distribution_location.pdf",  width=8, height=6) #units="in",
# box6
# dev.off()
# 
# tiff("../output/figs/matrix_round1.tiff", units="in", width=6, height=6, res=75)
# m1_rd1
# dev.off()
# 
# tiff("../output/figs/matrix_round2.tiff", units="in", width=6, height=6, res=75)
# m1_rd2
# dev.off()
# 
# tiff("../output/figs/matrix_round3.tiff", units="in", width=6, height=6, res=75)
# m1_rd3
# dev.off()
# 
# tiff("../output/figs/matrix_round4.tiff", units="in", width=6, height=6, res=75)
# m1_rd4
# dev.off()
# 
# tiff("../output/figs/matrix_all_rounds.tiff", units="in", width=20, height=18, res=75)
# m_all
# dev.off()

# tiff("../output/figs/matrix_difference12.tiff", units="in", width=6, height=6, res=150)
# diff_matr1
# dev.off()
# 
# tiff("../output/figs/matrix_difference23.tiff", units="in", width=6, height=6, res=150)
# diff_matr2
# dev.off()
# 
# tiff("../output/figs/matrix_difference34.tiff", units="in", width=6, height=6, res=150)
# diff_matr3
# dev.off()
# 
# tiff("../output/figs/matrix_difference14.tiff", units="in", width=6, height=6, res=150)
# diff_matr4
# dev.off()
# 
# tiff("../output/figs/matrix_difference_all.tiff", units="in", width=18, height=14, res=75)
# diff_matrix
# dev.off()
```

# COVID-19 transmission Models
```{r}


source("../../publication/scripts/02a_transmission_model_index.Rmd")

```

