---
title: "Comparison of round 1-4 data"
author: "Moses Kiti"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    # number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, comment = NA)

rm(list=ls())

source("../scripts/00a_required_libraries.R")
source("../scripts/00b_useful_functions.R")

```

```{r recoding, echo=FALSE, include=FALSE, warning=FALSE}

#  read in the files for rounds
participant_rd1 <- readRDS("../data/df_participant_clean_rd1.RDS")  # Participant information
contact_rd1 <- readRDS("../data/df_contact_clean_rd1.RDS")
day_rd1 <- readRDS("../data/df_day_clean_rd1.RDS")           # Metadata on participant's day

participant_rd2 <- readRDS("../data/df_participant_clean_rd2.RDS")  # Participant information
contact_rd2 <- readRDS("../data/df_contact_clean_rd2.RDS")          # Contact information
df_rd2 <- readRDS("../data/df_merged_rd2.RDS")

#  read in the files for round 3 
participant_rd3 <- readRDS("../data/df_participant_clean_rd3.RDS")  # Participant information
contact_rd3 <- readRDS("../data/df_contact_clean_rd3.RDS")          # Contact information
# df_rd3 <- readRDS("../data/df_merged_clean_rd3.RDS")

#  read in the files for round 4 
participant_rd4 <- readRDS("../data/df_participant_clean_rd4.RDS")  # Participant information
contact_rd4 <- readRDS("../data/df_contact_clean_rd4.RDS")          # Contact information
# df_rd3 <- readRDS("../data/df_merged_clean_rd3.RDS")

## select and rename vars to same format

# round 1 data
names(participant_rd1)
participant_rd1 <- participant_rd1 %>%
  select(part_id, gender, age_cat, edu, race, hispanic, hh_str, comp) %>%
  mutate(edu = ifelse(edu=="Bachelor's degree in college (4-year)" | 
                        edu=="Doctoral degree or Professional degree (PhD, JD, MD)" | 
                        edu=="Master's degree", "Bachelors or higher", 
                      "Less than Bachelors")) %>%
  mutate(hh_str = ifelse(hh_str=="Live alone","Alone",
                         ifelse(hh_str=="Live with parent", "Extended",
                                ifelse(hh_str=="Spouse and children only", "Nuclear",
                                       ifelse(hh_str=="Spouse only", "Nuclear", 
                                              ifelse(hh_str=="Roommate or sibling", "Roommates", "Other")))))) %>%
  rename(participant_id = part_id,
         participant_age = age_cat,
         participant_sex = gender,
         education = edu,
         family_structure = hh_str,
         company = comp) %>%
  mutate(round = "One") %>%
  arrange(company, participant_id, participant_age, participant_sex, education, race, hispanic, family_structure)
participant_rd1$participant_sex[participant_rd1$participant_sex == "I don't know"] <- "Not reported"
participant_rd1$company[participant_rd1$company == "accenture"] <- "Accenture"
participant_rd1$company[participant_rd1$company == "emory"] <- "Emory 1599"
participant_rd1$company[participant_rd1$company == "guidehouse"] <- "Guidehouse"
participant_rd1$hispanic[participant_rd1$hispanic == "None of these"] <- "No"

# round 2 data 
names(participant_rd2)
participant_rd2 <- participant_rd2 %>%
  select(id, participant_sex, participant_age_2, education2, race, hispanic, family_structure, company) %>% # num_hh
  rename(participant_id = id,
         participant_age = participant_age_2,
         education = education2) %>%
    mutate(round = "Two") %>%
  arrange(company, participant_id, participant_age, participant_sex, education, race, hispanic, family_structure)
participant_rd2$hispanic[participant_rd2$hispanic == "None of these"] <- "No"
participant_rd2$company[participant_rd2$company == "Emory"] <- "Emory 1599"

# round 3 data 
names(participant_rd3)
participant_rd3 <- participant_rd3 %>%
  select(id, participant_sex, participant_age_2, education2, race, hispanic2, family_structure, company) %>% # num_hh
  rename(participant_id = id,
         participant_age = participant_age_2,
         education = education2,
         hispanic = hispanic2) %>%
    mutate(round = "Three") %>%
  arrange(company, participant_id, participant_age, participant_sex, education, race, hispanic, family_structure)
participant_rd3$company[participant_rd3$company == "Intergral"] <- "Integral"

# round 4 data 
names(participant_rd4)
participant_rd4 <- participant_rd4 %>%
  select(id, participant_sex, participant_age_2, education2, race, hispanic2, family_structure, company) %>% # num_hh
  rename(participant_id = id,
         participant_age = participant_age_2,
         education = education2,
         hispanic = hispanic2) %>%
    mutate(round = "Four") %>%
  arrange(company, participant_id, participant_age, participant_age, participant_sex, education, race, hispanic, family_structure)


## merge participant dfs
participants <- rbind(participant_rd1, participant_rd2, participant_rd3, participant_rd4)
# rm(participant_rd1, participant_rd2)

## factorize
participants$round <- as.factor(participants$round)

participants$participant_age_2 <- participants$participant_age
participants$participant_age_2 <- factor(participants$participant_age_2, order=TRUE,
                                       levels = c("20-29", "30-39", "40-49", "50-59", "60+"))

participants$participant_age[participants$participant_age=="40-49"] <- "40-59"
participants$participant_age[participants$participant_age=="50-59"] <- "40-59"
participants$participant_age <- factor(participants$participant_age, order=TRUE,
                                       levels = c("20-29", "30-39", "40-59", "60+"))

table(participants$participant_sex)
participants$participant_sex[participants$participant_sex=="Prefer not to answer"] <- "Not reported"
participants$participant_sex <- factor(participants$participant_sex,
                                levels = c("Female", "Male", "Not reported"))

participants$education <- factor(participants$education,
                                levels = c("Less than Bachelors", "Bachelors or higher"),
                                labels = c("Lower than Bachelors", "Bachelors or higher"))

participants$race <- factor(participants$race,
                                levels = c("Asian","Black","White","Mixed","Other"))

participants$hispanic <- factor(participants$hispanic,
                                levels = c("Yes","No"))

participants$family_structure <- factor(participants$family_structure,
                                        levels=c("Alone", "Nuclear", "Extended", 
                                                 "Roommates", "Other"),
                                        labels=c("Live alone", "Nuclear", "Extended", 
                                                 "With roommates", "Other"))

participants$company <- factor(participants$company)
participants$round <- factor(participants$round,
                             levels = c("One", "Two", "Three", "Four"))


# 2. contact files
# names(contact_rd1)
contact_rd1 <- contact_rd1 %>%
  mutate(contact_location = ifelse(cont_home == "1", "Home", 
                                   ifelse(work == "1", "Work", "Community"))) %>%
  mutate(cont_attr = ifelse(cont_attr=="conv_only", "Conversation","Physical")) %>%
  mutate(round="One",
         contact_relation=NA) %>%
  rename(participant_id = part_id,
         contact_id = cont_id,
         fromdayone = contact_fromdayone,
         contact_sex = contact_gender,
         contact_type = cont_attr) %>%
  select(participant_id, contact_id, contact_age, contact_sex, contact_relation,
         contact_location, contact_type, round) %>%
  arrange(participant_id, contact_id, contact_age, contact_sex, contact_relation,
          contact_location, contact_type, round) # contact_relation2,
contact_rd1$contact_sex[contact_rd1$contact_sex == "I don't know"] <- "Not reported"

day_rd1 <- day_rd1 %>%
  rename(participant_id = part_id,
         num_contacts = social_cont) %>%
  select(participant_id, num_contacts) %>%
  left_join(participant_rd1, by="participant_id")

## 
# names(contact_rd2)
contact_rd2 <- contact_rd2 %>%
  select(id, contact_id, contact_age_4, contact_sex, contact_relation2, 
         contact_type, contact_location2) %>%
  mutate(round="Two") %>%
    mutate(contact_location2 = ifelse(contact_location2 == "Home", "Home", 
                                   ifelse(contact_location2 == "Work", "Work", "Community"))) %>%
  rename(participant_id = id,
         contact_age = contact_age_4,
         contact_location = contact_location2,
         contact_relation = contact_relation2) %>%
  arrange(participant_id, contact_id, contact_age, contact_sex, contact_relation, 
          contact_location, contact_type, round)

temp_contacts_rd2 <- contact_rd2 %>%
group_by(participant_id) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n())

# round 3
# names(contact_rd3)
contact_rd3 <- contact_rd3 %>%
  select(id, contact_id, contact_age_4, contact_sex, contact_type, contact_relation2,
         contact_location2, contact_type) %>%
  mutate(round="Three") %>%
  mutate(contact_location2 = ifelse(contact_location2 == "Home", "Home", 
                                    ifelse(contact_location2 == "Work", "Work", "Community"))) %>%
  rename(participant_id = id,
         contact_age = contact_age_4,
         contact_location = contact_location2,
         contact_relation = contact_relation2) %>%
  arrange(participant_id, contact_id, contact_age, contact_sex, contact_relation, 
          contact_location, contact_type, round)

# round 4
# names(contact_rd4)
contact_rd4 <- contact_rd4 %>%
  select(id, contact_id, contact_age_4, contact_sex, contact_type, contact_relation2,
         contact_location2) %>%
  mutate(round="Four") %>%
  mutate(contact_location2 = ifelse(contact_location2 == "Home", "Home", 
                                    ifelse(contact_location2 == "Work", "Work", "Community"))) %>%
  rename(participant_id = id,
         contact_age = contact_age_4,
         contact_location = contact_location2,
         contact_relation = contact_relation2) %>%
  arrange(participant_id, contact_id, contact_age, contact_sex, contact_relation, 
          contact_location, contact_type, round)

contacts <- rbind(contact_rd1, contact_rd2, contact_rd3, contact_rd4)
contacts$round <- factor(contacts$round,
                             levels = c("One", "Two", "Three","Four"))
# rm(contact_rd1, contact_rd2)

# join participant and contact files for rounds
vars1 <- c("participant_id","participant_sex","participant_age",
           "participant_age_2","education","race","hispanic",
           "family_structure", "contact_relation", "company", "round", 
           "contact_id", "contact_age", "contact_sex", 
           "contact_location", "contact_type")

rd1 <- participants %>%
  filter(round=="One") %>%
  left_join(contact_rd1, by="participant_id")  %>%
  drop_na(contact_age) %>%
  rename(round = round.x) %>%
  select(vars1)

rd2 <- participants %>%
  filter(round=="Two") %>%
  left_join(contact_rd2, by="participant_id") %>%
  rename(round = round.x) %>%
  select(vars1)

rd3 <- participants %>%
  filter(round=="Three") %>%
  left_join(contact_rd3, by="participant_id") %>%
  rename(round = round.x) %>%
  select(vars1)

rd4 <- participants %>%
  filter(round=="Four") %>%
  left_join(contact_rd4, by="participant_id") %>%
  rename(round = round.x) %>%
  select(vars1)

df_all <- rbind(rd1, rd2, rd3, rd4)
df_all$round <- factor(df_all$round,
                       levels = c("One", "Two", "Three", "Four"))

# rm(rd1, rd2, rd3)
```


```{r variables, include=FALSE, echo=FALSE}
vars2 <- c("company", "participant_sex", "participant_age", "education",
         "family_structure", "race", "hispanic", "round") # "marital",
```


### Table 1: Compare characteristics of participants across rounds
Table showing the distribution of participant characteristics by company, age, sex, education level, family structure, race, Hispanic origins for round 1-4 of the survey.
```{r baseline_participants, echo=FALSE, warnings=FALSE}
# install.packages("compareGroups")
# library(compareGroups)
# compare <- compareGroups(round ~ ., data = participants)

label(participants$company) <- "Company"
label(participants$participant_age) <- "Age"
label(participants$participant_age_2) <- "Age"
label(participants$participant_sex) <- "Sex"
label(participants$education) <- "Education"
label(participants$race) <- "Race"
label(participants$hispanic) <- "Hispanic"
label(participants$family_structure) <- "Family structure"

t1 <- participants %>%
  select(company, participant_sex, participant_age_2, education,
         family_structure, race, hispanic, round) %>%
  tbl_summary(by=round, 
              percent="column",
              digits = all_categorical() ~ 0,
              missing="no") %>%
  add_overall() %>%
  bold_labels() %>%
  modify_header(label = "") %>%
  modify_spanning_header(c("stat_1", "stat_2", "stat_3") ~ "**Survey round**") %>%
  modify_caption("**Table 1: Baseline characteristics of participants across rounds.**")

t1

# save table
t1a <- as_tibble(t1)
write.csv(t1a, "../output/tables/table1_participant_characteristics.csv")
rm(t1a)
# library(table1)
# table1(~ company + participant_age + participant_sex + education + race+ hispanic + family_structure | round,
#        data=participants, render.missing=NULL, topclass="Rtable1-zebra", 
#        caption = "Table: Comparing round 1 and round 2 data",
#        footnote = "This compares round 1 (April-June 2020) and round 2 (December 2020-February 2021). In round 2, two additional companies contributed data to the survey.")
```

\
\

### Table 2: Compare characteristics of contacts across rounds
```{r contact_baseline, echo=FALSE, warning=FALSE}

label(contacts$contact_age) <- "Age of contact"
label(contacts$contact_sex) <- "Sex of contact"
label(contacts$contact_location) <- "Location of contact"
label(contacts$contact_type) <- "Type of contact"
# label(contacts$contact_relation2) <- "Relationship to contact"


t2 <- contacts %>%
  select(contact_age, contact_sex, contact_location, 
         contact_type, round) %>%
  tbl_summary(by=round, 
              percent="column",
              digits = all_categorical() ~ 0,
              missing="no") %>%
  add_overall() %>%
  modify_header(label = "") %>%
  modify_spanning_header(c("stat_1", "stat_2", "stat_3") ~ "**Survey round**") %>%
  modify_caption("**Table 2: Characteristics of contacts across rounds.**") %>%
  bold_labels()
t2

# save table
t2a <- as_tibble(t2)
write.csv(t2a, "../output/tables/table2_contact_characteristics.csv")
rm(t2a)
# table1(~ contact_age + contact_sex + contact_location + contact_type | round,
#        data=contacts,render.missing=NULL)
```
\
\

### Table 3: Average contacts by round
```{r table3, include=FALSE}
# r1_contacts <- day_rd1 %>%
#   select("participant_id","round") %>%
#   filter(round=="One") %>%
#   group_by(participant_id) %>%
#   summarise(r1_contacts = n())

r1_contacts <- day_rd1 %>%
  # .[!duplicated(.$participant_id),] %>%
    rename(r1_contacts = num_contacts) %>%
  select(participant_id, r1_contacts)

r2_contacts <- df_all %>%
  select("participant_id","round") %>%
  filter(round=="Two") %>%
  group_by(participant_id) %>%
  summarise(r2_contacts = n())

r3_contacts <- df_all %>%
  select("participant_id","round") %>%
  filter(round=="Three") %>%
  group_by(participant_id) %>%
  summarise(r3_contacts = n())

r4_contacts <- df_all %>%
  select("participant_id","round") %>%
  filter(round=="Four") %>%
  group_by(participant_id) %>%
  summarise(r4_contacts = n())

df_allb <- left_join(df_all, r1_contacts, by="participant_id")
df_allb <- left_join(df_allb, r2_contacts, by="participant_id")
df_allb <- left_join(df_allb, r3_contacts, by="participant_id")
df_allb <- left_join(df_allb, r4_contacts, by="participant_id")

df_allb$r1_contacts <- as.numeric(df_allb$r1_contacts)
df_allb$r2_contacts <- as.numeric(df_allb$r2_contacts)
df_allb$r3_contacts <- as.numeric(df_allb$r3_contacts)
df_allb$r4_contacts <- as.numeric(df_allb$r4_contacts)

# # for sex, drop 20 records with "Not reported"
# df_allb <- df_allb %>%
#   subset(participant_sex != "Not reported")
# df_allb$participant_sex <- droplevels(df_allb$participant_sex)
```

```{r, include=FALSE, echo=FALSE}
# check the median contacts for day 1.

```

```{r}
## generate summary table
list <- list(0)  ## empty list

## specify participant characteristic stratifications for cross tabs/analysis
variables <- data.frame(var=c("participant_sex","participant_age_2", "family_structure",
                              "contact_relation", "contact_location", 
                              "company", "race", "hispanic"),
                        name=c("Sex","Age Group", "Family structure", 
                               "Relationship to contact", "Location of contact",
                               "Company","Race","Hispanic")) %>% # "Relationship to contact"
  mutate(var = as.character(var),
         name = as.character(name))

# table(df_rd4b$participant_sex)

for (i in 1:nrow(variables)){
  x <- df_all[,variables$var[[i]]] # participant[,variables$var[[i]]]
  variables$var[[i]]

# Number and proportion of participants in each strata
  
  t0 <- as.data.frame(cbind(table(x), # Total 
                            round(prop.table(table(x))*100, digits=0))) # Proportion
  
  colnames(t0)[1:2] <- c("Total","Col") 
  Tot <- rep("",5)
  
  # Median contacts for round 1
  t1 <- df_allb %>%
    filter(round =="One") %>%
    droplevels(.$company) %>%
    distinct(participant_id, .keep_all = TRUE) %>% # since this is total contacts per person, keep only 1 distinct record
    group_by(.dots = variables$var[[i]]) %>% 
    do(data.frame(t(quantile(.$r1_contacts, na.rm=TRUE, probs=c(0.25,0.5,0.75))))) # Median and IQR      
  t1$med_contact <- as.character(paste(t1$X50.," (",t1$X25.,"-",t1$X75.,")",sep="")) # Formatting for export
  
  # Median contacts for round 2
  t2 <- df_allb %>%
    filter(round == "Two") %>%
    distinct(participant_id, .keep_all = TRUE) %>% # since this is total contacts per person, keep only 1 distinct record
    group_by(.dots = variables$var[[i]]) %>% 
    do(data.frame(t(quantile(.$r2_contacts, na.rm=TRUE, probs=c(0.25,0.5,0.75))))) # Median and IQR      
  t2$med_contact <- as.character(paste(t2$X50.," (",t2$X25.,"-",t2$X75.,")",sep="")) # Formatting for export
  
  # Median contacts for round 3
  t3 <- df_allb %>%
    filter(round == "Three") %>%
    # droplevels(.$race) %>%
    distinct(participant_id, .keep_all = TRUE) %>% # since this is total contacts per person, keep only 1 distinct record
    group_by(.dots = variables$var[[i]]) %>% 
    do(data.frame(t(quantile(.$r3_contacts, na.rm=TRUE, probs=c(0.25,0.5,0.75))))) # Median and IQR      
  t3$med_contact <- as.character(paste(t3$X50.," (",t3$X25.,"-",t3$X75.,")",sep="")) # Formatting for export 
  
  # Median contacts for round 4
  t4 <- df_allb %>%
    filter(round == "Four") %>%
    # droplevels(.$race) %>%
    distinct(participant_id, .keep_all = TRUE) %>% # since this is total contacts per person, keep only 1 distinct record
    group_by(.dots = variables$var[[i]]) %>% 
    do(data.frame(t(quantile(.$r4_contacts, na.rm=TRUE, probs=c(0.25,0.5,0.75))))) # Median and IQR      
  t4$med_contact <- as.character(paste(t4$X50.," (",t4$X25.,"-",t4$X75.,")",sep="")) # Formatting for export
  #   out <- paste0("This is my output of iteration ", i, ".")  # Some output
  #   print(out)
  # }

  # because R1 has 3 companies compared to 5 in the others, we use qpcR:::cbind.na() to bind the columns, else we get an error.
  t0<-qpcR:::cbind.na(t0, t1$med_contact, t2$med_contact, t3$med_contact, t4$med_contact) # Bind columns together

  t0<- t0[,c(1,2,3,4,5,6)] # (1,2,3,4,5,6)
 
  t0$Total <- paste(t0$Total," (","", t0$Col,")",sep="")
  t0 <- t0[,c(1,3,4,5,6)]
  t0[,1]<-as.character(t0[,1])
  t0[,2]<-as.character(t0[,2])
  t0[,3]<-as.character(t0[,3])
  t0[,4]<-as.character(t0[,4])
  t0[,5]<-as.character(t0[,5])
 
  t0<-rbind(Tot, t0)
  
  rownames(t0)[1]<-variables$name[[i]]
  list[[i]] <- t0
}

res_restruct<- function(res){
  
  res1 <- lapply(res, as.data.frame)
  res1 <- do.call(rbind, res1)
  return(res1)
}

table_one <- res_restruct(list)
colnames(table_one) <- c("Total (%)", "Round 1", "Round 2", "Round 3", "Round 4")

kable(table_one, digits = 0, align = "r") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

write.csv(table_one, "../output/tables/table3_average_contacts.csv")
```
\
\

### Graphs of contacts by select covariates
The figure below shows the distribution of contacts by age for rounds 1-4.
```{r graphs1, warning=FALSE, echo=FALSE}

contacts_age <- df_all %>%
  group_by(participant_id, participant_age, round) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n())

contacts_sex <- df_all %>%
  group_by(participant_id, participant_sex, round) %>%   # group by id and count number of contacts
  filter(participant_sex != "Prefer not to answer") %>% # drop "Prefer not to answer"
  dplyr::summarize(num_contacts = n())

contacts_education <- df_all %>%
  group_by(participant_id, education, round) %>%   # group by id and count number of contacts
  drop_na(education) %>%
  dplyr::summarize(num_contacts = n())

contacts_race <- df_all %>%
  group_by(participant_id, race, round) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n())

box_colors <-  c("#08519c","#3182bd","#6baed6","#bdd7e7") # c("#0868ac", "#43a2ca", "7bccc4", "#bae4bc" ) #c("#dfc27d", "#80cdc1", "#a6611a")

box1 <- ggplot(contacts_age, aes(x = participant_age, y = num_contacts, fill=round))
box1 <- box1 +
  geom_boxplot(width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  # theme_cowplot() +
  theme_half_open() +
  scale_fill_manual(values = box_colors, labels = c("1", "2", "3", "4")) +
  scale_y_continuous(limits = c(0, 40)) +
  # xlab("Age group") + 
  # ylab("Number of contacts") + 
  labs(fill="Round",
       x = "Age group",
       y = "Number of contacts" ) +
  theme(legend.title = element_text(size=10),
        legend.text = element_text(size = 8),
        legend.position = c(0.1,0.9)) +
  theme(plot.title = element_text(size = 12), 
        axis.title.x = element_text(size=10, face="bold", angle=0),
        axis.title.y = element_text(size=10, face="bold"),
        axis.text.x = element_text(size = 8), # changed from txt_size (MK)
        axis.text.y = element_text(size= 8))
# box1 

box2 <- ggplot(contacts_sex, aes(x = participant_sex, y = num_contacts, fill=round))
box2 <- box2 +
  geom_boxplot(width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  # theme_cowplot() +
  theme_half_open() +
  scale_fill_manual(values = box_colors) +
  scale_y_continuous(limits = c(0, 40)) +
  xlab("Sex") + 
  ylab("") + 
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 12),
        legend.position = "none") +
  theme(plot.title = element_text(size = 12), 
          axis.title.x = element_text(size=10, face="bold", angle=0),
          axis.title.y = element_text(size=10, face="bold"),
          axis.text.x = element_text(size = 8), # changed from txt_size (MK)
          axis.text.y = element_text(size= 8))


# box3 <- # take out NA as option
box3 <- ggplot(contacts_education, aes(x = education, y = num_contacts, fill=round))
box3 <- box3 +
  geom_boxplot(width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  # theme_cowplot() +
  theme_half_open() +
  scale_fill_manual(values = box_colors) +
  scale_y_continuous(limits = c(0, 40)) +
  xlab("Education") + 
  ylab("Number of contacts") + 
  theme(legend.title= element_blank(),
        legend.text = element_text(size = 12),
        legend.position = "none") +
  theme(plot.title = element_text(size = 12), 
          axis.title.x = element_text(size=10, face="bold", angle=0),
          axis.title.y = element_text(size=10, face="bold"),
          axis.text.x = element_text(size = 8), # changed from txt_size (MK)
          axis.text.y = element_text(size= 8))

box4 <- ggplot(contacts_race, aes(x = race, y = num_contacts, fill=round))
box4 <- box4 +
  geom_boxplot(width = .50, position = position_dodge(0.6), outlier.size = 0.5) + #outlier.shape = NA,
  # theme_cowplot() +
  theme_half_open() +
  scale_fill_manual(values = box_colors) +
  scale_y_continuous(limits = c(0, 40)) +
  xlab("Race") + 
  ylab("") + 
  theme(legend.title= element_blank(),
        legend.text = element_text(size = 12),
        legend.position = c(0.1,0.9)) +
  theme(plot.title = element_text(size = 12), 
          axis.title.x = element_text(size=10, face="bold", angle=0),
          axis.title.y = element_text(size=10, face="bold"),
          axis.text.x = element_text(size = 8), # changed from txt_size (MK)
          axis.text.y = element_text(size= 8))

# legend <- get_legend(box1 + theme(legend.box.margin = margin(0, 0, 0, 12)))

box5 <- plot_grid(box1 + theme(legend.position = "none"), 
                  box2 + theme(legend.position = "none"),
                  box3 + theme(legend.position = "none"),
                  box4 + theme(legend.position = "none"),
                  align = 'vh',
                  labels = c("A","B","C","D"),
                  hjust = -1,
                  label_size = 10, nrow = 2)

# extract the legend from one of the plots
legend <- get_legend(
  box1 +
  theme(legend.position = "right"))

box5 <- plot_grid(box5, legend, rel_widths = c(2,.4))

# tiff("../output/figs/contact_distribution.tiff", units="in", width=8, height=6, res=300)
box5
```
\
\

```{r graphs2, warning=FALSE, echo=FALSE}
contacts_location_round <- df_all %>%
  group_by(participant_id, contact_location, round) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n())

box6 <- ggplot(contacts_location_round, aes(x = contact_location, y = num_contacts, fill=round))
box6 <- box6 +
  geom_boxplot(width = .50, position = position_dodge(0.6), outlier.size = 0.5, outlier.shape = NA) +
  # theme_cowplot() +
  theme_half_open() +
  scale_fill_manual(labels=c("Apr-Jun '20","Nov'20-Jan'21","Jun-Aug'21","Nov-Dec'21"), 
                    values = box_colors) +
  scale_y_continuous(limits = c(0, 20)) +
  # xlab("Age group") + 
  # ylab("Number of contacts") + 
  labs(fill="Round",
       x = "Location",
       y = "Number of contacts" ) +
  theme(legend.title = element_text(size=14),
        legend.text = element_text(size = 10),
        legend.position = c(0.1, .95),
        legend.direction="horizontal") +
  theme(plot.title = element_text(size = 12), 
        axis.title.x = element_text(size=20, face="bold", angle=0),
        axis.title.y = element_text(size=20, face="bold"),
        axis.text.x = element_text(size = 16), # changed from txt_size (MK)
        axis.text.y = element_text(size= 16))
box6
# tiff("../output/figs/contact_distribution_location.tiff", units="in", width=8, height=6, res=150)
# dev.off()
```
\
\
\

### Comparison of median (IQR) contacts by round.
```{r stat_tests, warning=FALSE, echo=FALSE, include=FALSE, comment = NA}
# Here, I compute the number of contacts as a line list count of each person with whom the participant had a contact. This is done same way as for temp 2.  
# temp2 <- df_all %>%
#   filter(round=="Two") %>% # keep round 1 contacts only
#   group_by(participant_id, participant_age) %>%   # group by id and count number of contacts
#   dplyr::summarize(num_contacts = n()) %>%
#   mutate(round="Two")

# However, doing it the way above (temp2) produces summary results that are different from what we reported in the manuscript we published. Hence, I use the variable day_rd1$social_cont file to compute the summary statistics.
temp1 <- day_rd1 %>%
  # rename(num_contacts = social_cont) %>%
  .[!duplicated(.$participant_id),] %>%
  select(participant_id, num_contacts) %>%
  mutate(round="One")

temp2 <- df_all %>%
  filter(round=="Two") %>% # keep round 2 contacts only
  group_by(participant_id, participant_age) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n()) %>%
  select(participant_id, num_contacts) %>%
  mutate(round="Two")

temp3 <- df_all %>%
  filter(round=="Three") %>% # keep round 3 contacts only
  group_by(participant_id, participant_age) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n()) %>%
  select(participant_id, num_contacts) %>%
  mutate(round="Three")

temp4 <- df_all %>%
  filter(round=="Four") %>% # keep round 4 contacts only
  group_by(participant_id, participant_age) %>%   # group by id and count number of contacts
  dplyr::summarize(num_contacts = n()) %>%
  select(participant_id, num_contacts) %>%
  mutate(round="Four")


df_contacts_round <- rbind(temp1, temp2, temp3, temp4)
rm(temp1, temp2, temp3, temp4)

# 1. here, for each of the rounds, we calculate the mean (sd) and median (IQR) values. Due to the non-normal distribution of the data, we conduct a Kruskal-Wallis rank-sum test of significance.
summary_rounds <- group_by(df_contacts_round, round) %>%
  summarise(
    count = n(),
    mean = mean(num_contacts, na.rm = TRUE),
    sd = sd(num_contacts, na.rm = TRUE),
    median = median(num_contacts, na.rm = TRUE),
    # qs = quantile(num_contacts, c(0.25, 0.75)), prob = c(0.25, 0.75))
    q1 = quantile(num_contacts, c(0.25), prob = c(0.25), na.rm = TRUE),
    q3 = quantile(num_contacts, c(0.75), prob = c(0.75), na.rm = TRUE))
# summary_rounds

# 2. Kruskall Wallis test of change.
test_rounds_12 <- df_contacts_round %>%
  filter(round=="One" | round=="Two")
test_rounds_12 <- kruskal.test(num_contacts ~ round, 
                            data = test_rounds_12)

test_rounds_23 <- df_contacts_round %>%
  filter(round=="Two" | round=="Three")
test_rounds_23 <- kruskal.test(num_contacts ~ round, 
                            data = test_rounds_23)

test_rounds_34 <- df_contacts_round %>%
  filter(round=="Three" | round=="Four")
test_rounds_34 <- kruskal.test(num_contacts ~ round, 
                            data = test_rounds_34)
# test_rounds

# Visualization
library("ggpubr")

p1 <- ggbarplot(df_contacts_round, x = "round", y = "num_contacts",
       add = c("median_q1q3"),
       order = c("One", "Two", "Three", "Four"),
       color = c("black"),
       fill = box_colors,
       ylab = "Number of contacts", xlab = "Round",
       label=TRUE,
       lab.vjust = -1.0, lab.hjust = -1.0,
       position = position_dodge(0.1))
tiff("../output/figs/fig2_median_all_rounds.tiff", units="in", width=6, height=6, res=300)
p1
dev.off()
# There is a significant difference in the mean contact values between round 1 and round 2 (Kruskal-Wallis rank sum test, p=`r test_rounds_12$p.value`) and round 2 and 3 (Kruskal-Wallis rank sum test, p=`r test_rounds_23$p.value`).

```
\
\
```{r}
p1
```
The median (IQR) contact rates for round 1, 2,  3 and 4 were 
`r summary_rounds$median[2]` (`r summary_rounds$q1[2]`, `r summary_rounds$q3[2]`),  
`r summary_rounds$median[4]` (`r summary_rounds$q1[4]`, `r summary_rounds$q3[4]`), 
`r summary_rounds$median[3]` (`r summary_rounds$q1[3]`, `r summary_rounds$q3[3]`), and
`r summary_rounds$median[1]` (`r summary_rounds$q1[1]`, `r summary_rounds$q3[1]`), 
respectively.
\
\

### Matrices by study round
```{r graphs3, warning=FALSE, echo=FALSE, comment = NA, fig.width = 18, fig.height = 14}
# # round 1 matrix
# # source("../scripts/01c_cleaning_generate_matrix_round_1.R")
# # Read in Data from Round 1

# table(df_all$contact_age)
# table(df_all$participant_age)
participants$participant_age <- as.character(participants$participant_age)

## Create dummy data frame of standard structure for contact matrix
standard_str <- data.frame(participant_age = rep(c("0-9","10-19","20-29","30-39","40-59","60+"),6),
                            contact_age = rep(unique(contacts$contact_age),each = 6))
standard_str$contact_age <- as.character(standard_str$contact_age)


## Number participants by age group
num_participants_rd1 <- participants %>%
  filter(round == "One") %>%
  group_by(participant_age) %>%
  dplyr::summarize(n=n())
num_participants_rd1$participant_age <- as.character(num_participants_rd1$participant_age) 

## Contact matrix
rd1$participant_age <- as.character(rd1$participant_age)
m1_rd1 <- make_matrix_rd1(rd1,
                          title = "A. Apr-Jun 2020 (N=304)",
                          legendpos ="none") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), 
            color = "black", size = 8) +
  theme(axis.title.x = element_blank())


## Round 2 matrix
df_rd2_temp <- rd2 %>%
  select(participant_id, participant_age, contact_age) 
df_rd2_temp$participant_age <- as.character(df_rd2_temp$participant_age)
df_rd2_temp$contact_age <- as.character(df_rd2_temp$contact_age)

## Number participants by age group
num_participants_rd2 <- participants %>%
  filter(round == "Two") %>%
  group_by(participant_age) %>%
  dplyr::summarize(n=n())

m1_rd2 <- make_matrix_rd2(
  df_rd2_temp %>%
    filter(!is.na(contact_age)), # Remove those without contact age
  replace(is.na(.), 0),
  title = "B. Nov 2020-Jan 2021 (N=343)",
  legendpos ="none") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), 
            color = "black", size = 8) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())
  


## Round 3 matrix
df_rd3_temp <- rd3 %>%
  select(participant_id, participant_age, contact_age)
df_rd3_temp$participant_age <- as.character(df_rd3_temp$participant_age)
df_rd3_temp$contact_age <- as.character(df_rd3_temp$contact_age)

## Number participants by age group
num_participants_rd3 <- participants %>%
  filter(round == "Three") %>%
  group_by(participant_age) %>%
  dplyr::summarize(n=n())

m1_rd3 <- make_matrix_rd3(
  df_rd3_temp %>%
    filter(!is.na(contact_age)), # Remove those without contact age
  replace(is.na(.), 0),
  title = "C. Jun-Aug 2021 (N=376)",
  legendpos ="none") +   
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), 
            color = "black", size = 8)



## Round 4 matrix
df_rd4_temp <- rd4 %>%
  select(participant_id, participant_age, contact_age)
df_rd4_temp$participant_age <- as.character(df_rd4_temp$participant_age)
df_rd4_temp$contact_age <- as.character(df_rd4_temp$contact_age)

## Number participants by age group
num_participants_rd4 <- participants %>%
  filter(round == "Four") %>%
  group_by(participant_age) %>%
  dplyr::summarize(n=n())

m1_rd4 <- make_matrix_rd4(
  df_rd4_temp %>%
    filter(!is.na(contact_age)), # Remove those without contact age
  replace(is.na(.), 0),
  title = "D. Nov-Dec 2021 (N=433)",
  legendpos ="none") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), 
            color = "black", size = 8) +
  theme(axis.title.y = element_blank())


# get legend
legend_m1 <- get_legend(
  m1_rd4 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "right",
          legend.justification = "left"))

m_all <- plot_grid(m1_rd1, m1_rd2, legend_m1,
                   m1_rd3, m1_rd4,
          # labels = c("A","B","","C","D"),
          # label_size = 22,
          ncol=3, nrow=2, rel_widths=c(1.2,1.15,.2),
          scale=0.95, align="hv")

m_all
```

```{r, include=FALSE}

tiff("../output/figs/contact_distribution_location.tiff", units="in", width=8, height=6, res=150)
box6
dev.off()

tiff("../output/figs/matrix_round1.tiff", units="in", width=6, height=6, res=150)
m1_rd1
dev.off()

tiff("../output/figs/matrix_round2.tiff", units="in", width=6, height=6, res=150)
m1_rd2
dev.off()

tiff("../output/figs/matrix_round3.tiff", units="in", width=6, height=6, res=150)
m1_rd3
dev.off()

tiff("../output/figs/matrix_round4.tiff", units="in", width=6, height=6, res=150)
m1_rd4
dev.off()

tiff("../output/figs/matrix_all_rounds.tiff", units="in", width=18, height=18, res=75)
m_all
dev.off()

```
\
\

### Matrices by location of contact
```{r location_matrices, warning=FALSE, echo=FALSE, comment = NA, fig.width = 24, fig.height = 18}

age_labels <- c("0-9"="0-", "10-19"="10-", "20-29"="20-",
"30-39"="30-", "40-59"="40-", "60+"="60+")

# Work
## Round 1
m1_rd1_work <- make_matrix_rd1(
  rd1 %>%
    filter(contact_location=="Work"),
  title = "Work", 
  legendpos ="") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 20),
        axis.title.y = element_text(size = 25))
# m1_rd1_work

## Round 2
m1_rd2_work <- make_matrix_rd2(
  rd2 %>%
    filter(contact_location=="Work"),
  title = "", 
  legendpos ="") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank())
# m1_rd2_work

## Round 3
m1_rd3_work <- make_matrix_rd3(
  rd3 %>%
    filter(contact_location=="Work"),
  title = "", 
  legendpos ="") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank())
# m1_rd3_work

# Round 4
m1_rd4_work <- make_matrix_rd4(
  rd4 %>%
    filter(contact_location=="Work"),
  title = "", 
  legendpos ="") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank())
# m1_rd4_work


# Home
m1_rd1_home <- make_matrix_rd1(
  rd1 %>%
    filter(contact_location=="Home"),
  title = "Home", 
  legendpos ="") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 20),
        axis.title.y = element_text(size = 25))
# m1_rd1_home

## Round 2
m1_rd2_home <- make_matrix_rd2(
  rd2 %>%
    filter(contact_location=="Home"),
  title = "", 
  legendpos ="") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank())
# m1_rd2_home

## Round 3
m1_rd3_home <- make_matrix_rd3(
  rd3 %>%
    filter(contact_location=="Home"),
  title = "", 
  legendpos ="")  +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank())
# m1_rd3_home

# Round 4
m1_rd4_home <- make_matrix_rd4(
  rd4 %>%
    filter(contact_location=="Home"),
  title = "", 
  legendpos ="") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank())
# m1_rd4_home


# Community
m1_rd1_comm <- make_matrix_rd1(
  rd1 %>%
    filter(contact_location=="Community"),
  title = "Community", 
  legendpos ="")  +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  scale_x_discrete(labels=age_labels) +
  theme(axis.title.x = element_text(size = 25),
        axis.text.x = element_text(size = 20),
        axis.title.y = element_text(size = 25),
        axis.text.y = element_text(size = 20))
# m1_rd1_comm

## Round 2
m1_rd2_comm <- make_matrix_rd2(
  rd2 %>%
    filter(contact_location=="Community"),
  title = "", 
  legendpos ="") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  scale_x_discrete(labels=age_labels) +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 25),
        axis.text.x = element_text(size = 20))
# m1_rd2_comm

## Round 3
m1_rd3_comm <- make_matrix_rd3(
  rd3 %>%
    filter(contact_location=="Community"),
  title = "", 
  legendpos ="")  +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  scale_x_discrete(labels=age_labels) +
  theme(axis.title.x = element_text(size = 25),
        axis.text.x = element_text(size = 20),
        axis.title.y = element_blank(),
        axis.text.y = element_blank())
# m1_rd3_comm

# Round 4
m1_rd4_comm <- make_matrix_rd4(
  rd4 %>%
    filter(contact_location=="Community"),
  title = "", 
  legendpos ="") +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 5) +
  scale_x_discrete(labels=age_labels) +
  theme(axis.title.x = element_text(size = 25),
        axis.text.x = element_text(size = 20),
        axis.title.y = element_blank(),
        axis.text.y = element_blank())
# m1_rd4_comm


m_location <- plot_grid(m1_rd1_work, m1_rd2_work, m1_rd3_work, m1_rd4_work, legend_m1,
                        m1_rd1_home, m1_rd2_home, m1_rd3_home, m1_rd4_home, NULL,
                        m1_rd1_comm, m1_rd2_comm, m1_rd3_comm, m1_rd4_comm, NULL,
                        nrow=3, ncol=5, align="hv", 
                        rel_widths=c(1.4,1,1,1,.2), rel_heights=c(1,1,1.2), scale=0.95)

print(m_location)
```

```{r, include=FALSE, fig.width = 20, fig.height = 16}
tiff("../output/figs/matrix_location_all.tiff", units="in", res=75)
m_location
dev.off()
```

```{r matrix_dfs, warning=FALSE, echo=FALSE, include=FALSE}

# matrix dataframes
## Round 1
df_m1_rd1 <- rd1 %>%
  group_by(participant_age, contact_age) %>%
  dplyr::summarize(tot_contacts = n()) %>%
  full_join(standard_str, by = c("participant_age","contact_age"), keep=F) %>%
  left_join(num_participants_rd1, by="participant_age") %>%
  mutate(avg_cont = (tot_contacts/n)) %>%
  replace(is.na(.), 0)

## Round 2
df_m1_rd2 <- rd2 %>%
  group_by(participant_age, contact_age) %>%
  dplyr::summarize(tot_contacts = n()) %>%
  full_join(standard_str, by = c("participant_age","contact_age"), keep=F) %>%
  left_join(num_participants_rd1, by="participant_age") %>%
  mutate(avg_cont = (tot_contacts/n)) %>%
  replace(is.na(.), 0)

## Round 3
df_m1_rd3 <- rd3 %>%
  group_by(participant_age, contact_age) %>%
  dplyr::summarize(tot_contacts = n()) %>%
  full_join(standard_str, by = c("participant_age","contact_age"), keep=F) %>%
  left_join(num_participants_rd1, by="participant_age") %>%
  mutate(avg_cont = (tot_contacts/n)) %>%
  replace(is.na(.), 0)

## Round 4
df_m1_rd4 <- rd4 %>%
  group_by(participant_age, contact_age) %>%
  dplyr::summarize(tot_contacts = n()) %>%
  full_join(standard_str, by = c("participant_age","contact_age"), keep=F) %>%
  left_join(num_participants_rd1, by="participant_age") %>%
  mutate(avg_cont = (tot_contacts/n)) %>%
  replace(is.na(.), 0)

```

### Weighted mixing matrices
Weighting is done to generate a contact matrix that is generaliable to the US workforce population. We extract employee data from the US Bureau of Labor Statistics (2020 data). Then, we extract employee numbers for the following categorizations: "management occupations", "business and financial operations occupations", "computer and mathematical occupations" and "life physical and social science occupations". These categories represent the job categories for the companies that have participated in our survey. However, the employment data are in discrete age groups (20, 21,..., 80) which is different to our questionnaire data (4 age groups). Hence, we adjust the employee population age categories to match the survey age categories as explained below: 
a) let total number of employees per age category = n(a); let the number of discrete ages per age category be a(i) e.g. for 20-24, i=20,21,22,23,24, etc; let number of discrete ages per age category be n_a(i); 
b) let number of people per discrete age be p(i), then, p(i) = n_a(i)/a(i)
c) to re-categorize for survey data, sum up p(i) for all age categories.

This has been done in Excel, data available in this file: "us_company_weights_052021.csv"

```{r weighted_matrix_dfs, warning=FALSE, echo=FALSE, comment = NA, fig.width = 18, fig.height = 14}

# employee weighted population data
employee_pop <- read_csv("../data/us_company_weights_052021.csv",
                            col_types = cols())
# select(age_cat, p_age, age_weight) %>%
employee_pop <-  as.numeric(employee_pop$n_employees)

col_names <- c("60+","40-59","30-39","20-29","10-19","0-9")
row_names <- c("60+","40-59","30-39","20-29","10-19","0-9")

# round 1 weighted matrix
# number of participants per age group, from part_age1
n_rd1 <- as.numeric(num_participants_rd1$n)

# unweighted matrix
m_rd1 <- matrix(df_m1_rd1$avg_cont,6,6,byrow=F)
m_rd1[is.na(m_rd1)] = 0

# this generates a square weighted reciprocal matrix for ages >20 years.
k <- 6
m_rd1_w <- matrix(0,k,k) 

for(i in 1:k){
  for(j in 1:k){
    m_rd1_w[i,j] <- (m_rd1[i,j]*employee_pop[i] + m_rd1_w[j,i]*employee_pop[j]) / 
      (employee_pop[i] + employee_pop[j])
    if(is.na(m_rd1_w[i,j]) | is.infinite(m_rd1_w[i,j])) m_rd1_w[i,j] <- 0
  }
}
m_rd1_w <- as.data.frame(m_rd1_w)
rownames(m_rd1_w) <- row_names
colnames(m_rd1_w) <- col_names

# round 2 weighted matrix
# number of participants per age group, from part_age1
n_rd2 <- as.numeric(num_participants_rd2$n)

# unweighted matrix
m_rd2 <- matrix(df_m1_rd2$avg_cont,6,6,byrow=F)
m_rd2[is.na(m_rd2)] = 0

# this generates a square weighted reciprocal matrix for ages >20 years.
# k <- 6
m_rd2_w <- matrix(0,k,k) 

for(i in 1:k){
  for(j in 1:k){
    m_rd2_w[i,j] <- (m_rd2[i,j]*employee_pop[i] + m_rd2_w[j,i]*employee_pop[j]) / 
      (employee_pop[i] + employee_pop[j])
    if(is.na(m_rd2_w[i,j]) | is.infinite(m_rd2_w[i,j])) m_rd2_w[i,j] <- 0
  }
}
m_rd2_w <- as.data.frame(m_rd2_w)
rownames(m_rd2_w) <- row_names
colnames(m_rd2_w) <- col_names


# round 3 weighted matrix
# number of participants per age group, from part_age1
n_rd3 <- as.numeric(num_participants_rd3$n)

# unweighted matrix
m_rd3 <- matrix(df_m1_rd3$avg_cont,6,6,byrow=F)
m_rd3[is.na(m_rd3)] = 0

# this generates a square weighted reciprocal matrix for ages >20 years.
# k <- 6
m_rd3_w <- matrix(0,k,k) 

for(i in 1:k){
  for(j in 1:k){
    m_rd3_w[i,j] <- (m_rd3[i,j]*employee_pop[i] + m_rd3_w[j,i]*employee_pop[j]) / 
      (employee_pop[i] + employee_pop[j])
    if(is.na(m_rd3_w[i,j]) | is.infinite(m_rd3_w[i,j])) m_rd3_w[i,j] <- 0
  }
}
m_rd3_w <- as.data.frame(m_rd3_w)
rownames(m_rd3_w) <- row_names
colnames(m_rd3_w) <- col_names


# round 4 weighted matrix
# number of participants per age group, from part_age1
n_rd4 <- as.numeric(num_participants_rd4$n)

# unweighted matrix
m_rd4 <- matrix(df_m1_rd4$avg_cont,6,6,byrow=F)
m_rd4[is.na(m_rd4)] = 0

# this generates a square weighted reciprocal matrix for ages >20 years.
# k <- 6
m_rd4_w <- matrix(0,k,k) 

for(i in 1:k){
  for(j in 1:k){
    m_rd4_w[i,j] <- (m_rd4[i,j]*employee_pop[i] + m_rd4_w[j,i]*employee_pop[j]) / 
      (employee_pop[i] + employee_pop[j])
    if(is.na(m_rd4_w[i,j]) | is.infinite(m_rd4_w[i,j])) m_rd4_w[i,j] <- 0
  }
}
m_rd4_w <- as.data.frame(m_rd4_w)
rownames(m_rd4_w) <- row_names
colnames(m_rd4_w) <- col_names

```
\
\

### Difference matrices among employees only
```{r difference_matrix, warning=FALSE, echo=FALSE, comment = NA, fig.width = 18, fig.height = 14}
# round 1-2
diff1 <- m_rd2_w - m_rd1_w
colnames(diff1) <- col_names
rownames(diff1) <- row_names

diff1 <- diff1 %>%
  as.data.frame() %>%
  rownames_to_column("participant_age") %>%
  pivot_longer(-c(participant_age), names_to = "contact_age", values_to = "avg_cont") 

diff_matr1 <- diff1 %>%
  filter(contact_age!="0-9") %>% filter(participant_age!="0-9") %>%
  filter(contact_age!="10-19") %>%  filter(participant_age!="10-19") %>%
  ggplot(aes(x=participant_age, y=contact_age, fill=avg_cont)) +
  geom_raster() +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 8) +
  theme_classic() +
  scale_fill_gradient(low="white", high="blue", limits=c(-2, 4), breaks=(c(-2,0,2,4))) +
  # scale_y_continuous(limits = c(-2, 2)) +
  labs(fill = "Avg \ncontact") +
  xlab("") + 
  ylab("Contact age") +
  ggtitle("A. Round 1 - 2") +
  theme(legend.title = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.justification = "right",
        legend.position = "") +
  theme(plot.title = element_text(size = 28), 
        axis.title.x = element_text(size=26, face="bold", angle=0),
        axis.title.y = element_text(size=26, face="bold"),
        axis.text.x = element_text(size = 24),
        axis.text.y = element_text(size= 24))
# diff_matr1

# round 2-3
diff2 <- m_rd3_w - m_rd2_w
colnames(diff2) <- col_names
rownames(diff2) <- row_names

diff2 <- diff2 %>%
  as.data.frame() %>%
  rownames_to_column("participant_age") %>%
  pivot_longer(-c(participant_age), names_to = "contact_age", values_to = "avg_cont") 

diff_matr2 <- diff2 %>%
  filter(contact_age!="0-9") %>% filter(participant_age!="0-9") %>%
  filter(contact_age!="10-19") %>%  filter(participant_age!="10-19") %>%
  ggplot(aes(x=participant_age, y=contact_age, fill=avg_cont)) +
  geom_raster() +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 8) +
  theme_classic() +
  scale_fill_gradient(low="white", high="blue", limits=c(-1, 4), breaks=(c(-2,0,2,4))) +
  # scale_y_continuous(limits = c(-2, 2)) +
  xlab("") + 
  ylab("") +
  ggtitle("B. Round 2 - 3") +
  theme(legend.title = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.justification = "right",
        legend.position = "") +
  theme(plot.title = element_text(size = 28), 
        axis.title.x = element_text(size=26, face="bold", angle=0),
        axis.title.y = element_text(size=26, face="bold"),
        axis.text.x = element_text(size = 24),
        axis.text.y = element_text(size= 24))
# diff_matr2

# round 4-3
diff3 <- m_rd4_w - m_rd3_w
colnames(diff3) <- col_names
rownames(diff3) <- row_names

diff3 <- diff3 %>%
  as.data.frame() %>%
  rownames_to_column("participant_age") %>%
  pivot_longer(-c(participant_age), names_to = "contact_age", values_to = "avg_cont")

diff_matr3 <- diff3 %>%
  filter(contact_age!="0-9") %>% filter(participant_age!="0-9") %>%
  filter(contact_age!="10-19") %>%  filter(participant_age!="10-19") %>%
  ggplot(aes(x=participant_age, y=contact_age, fill=avg_cont)) +
  geom_raster() +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 8) +
  theme_classic() +
  scale_fill_gradient(low="white", high="blue", limits=c(-2, 4), breaks=(c(-2,0,2,4))) +
  # scale_y_continuous(limits = c(-2, 2)) +
  xlab("Participant age") + 
  ylab("Contact age") +
  ggtitle("C. Round 3 - 4") +
  theme(legend.title = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.justification = "right",
        legend.position = "") +
  theme(plot.title = element_text(size = 28), 
        axis.title.x = element_text(size=26, face="bold", angle=0),
        axis.title.y = element_text(size=26, face="bold"),
        axis.text.x = element_text(size = 24),
        axis.text.y = element_text(size= 24))
# diff_matr3

# round 1-4
diff4 <- m_rd4_w - m_rd1_w
colnames(diff4) <- col_names
rownames(diff4) <- row_names

diff4 <- diff4 %>%
  as.data.frame() %>%
  rownames_to_column("participant_age") %>%
  pivot_longer(-c(participant_age), names_to = "contact_age", values_to = "avg_cont") 

diff_matr4 <- diff4 %>%
  filter(contact_age!="0-9") %>% filter(participant_age!="0-9") %>%
  filter(contact_age!="10-19") %>%  filter(participant_age!="10-19") %>%
  ggplot(aes(x=participant_age, y=contact_age, fill=avg_cont)) +
  geom_raster() +
  geom_text(aes(participant_age, contact_age, label = round(avg_cont, digits=1)), color = "black", size = 8) +
  theme_classic() +
  scale_fill_gradient(low="white", high="blue", limits=c(-2, 4), breaks=(c(-2,0,2,4))) +
  # scale_y_continuous(limits = c(-2, 2)) +
  xlab("Participant age") + 
  ylab("") +
  ggtitle("D. Round 1 - 4") +
  theme(legend.title = element_text(size = 18),
        legend.text = element_text(size = 18),
        legend.justification = "right",
        legend.position = "") +
  theme(plot.title = element_text(size = 28), 
        axis.title.x = element_text(size=26, face="bold", angle=0),
        axis.title.y = element_text(size=26, face="bold"),
        axis.text.x = element_text(size = 24),
        axis.text.y = element_text(size= 24))
# diff_matr4


# matr4 <- make_diff_matrix(
#   diff4 %>%
#     filter(!is.na(contact_age)), # Remove those without contact age
#   replace(is.na(.), 0),
#   title = "1-4",
#   legendpos ="none")
# matr4

# get legend
legend_mdiff <- get_legend(
  diff_matr1 + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "right",
          legend.justification = "left"))

diff_matrix <- plot_grid(diff_matr1, diff_matr2, legend_mdiff,
                         diff_matr3, diff_matr4,
                         # labels = c("A","B","",
                                    # "C","D"),
                         # label_size = 18, 
                         ncol=3, nrow=2, rel_widths = c(1,1,.2),
                         scale=0.95, align="hv")

print(diff_matrix)
```

```{r, include=FALSE}

tiff("../output/figs/matrix_difference12.tiff", units="in", width=6, height=6, res=150)
diff_matr1
dev.off()

tiff("../output/figs/matrix_difference23.tiff", units="in", width=6, height=6, res=150)
diff_matr2
dev.off()

tiff("../output/figs/matrix_difference34.tiff", units="in", width=6, height=6, res=150)
diff_matr3
dev.off()

tiff("../output/figs/matrix_difference14.tiff", units="in", width=6, height=6, res=150)
diff_matr4
dev.off()

tiff("../output/figs/matrix_difference_all.tiff", units="in", width=18, height=14, res=75)
diff_matrix
dev.off()
```

```{r q_index, include=FALSE}
# Q_rd1 <- sum(diag(df_m1_rd1$P))-1)/(dim(z$P)[1]-1)

```